<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.12">
<meta name="author" content="Miguel Barajas">
<title>Introducción a Infraestructura como Código (IaC)</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/* Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment @import statement to use as custom stylesheet */
/*@import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700";*/
article,aside,details,figcaption,figure,footer,header,hgroup,main,nav,section{display:block}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
html{font-family:sans-serif;-ms-text-size-adjust:100%;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
abbr[title]{border-bottom:1px dotted}
b,strong{font-weight:bold}
dfn{font-style:italic}
hr{-moz-box-sizing:content-box;box-sizing:content-box;height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type="button"],input[type="reset"],input[type="submit"]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type="checkbox"],input[type="radio"]{box-sizing:border-box;padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,*::before,*::after{-moz-box-sizing:border-box;-webkit-box-sizing:border-box;box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;font-weight:400;font-style:normal;line-height:1;position:relative;cursor:auto;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{font-family:inherit;font-weight:400;font-size:1em;line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em;height:0}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{font-size:1em;line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0;font-size:1em}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
abbr,acronym{text-transform:uppercase;font-size:90%;color:rgba(0,0,0,.8);border-bottom:1px dotted #ddd;cursor:help}
abbr{text-transform:none}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote cite{display:block;font-size:.9375em;color:rgba(0,0,0,.6)}
blockquote cite::before{content:"\2014 \0020"}
blockquote cite a,blockquote cite a:visited{color:rgba(0,0,0,.6)}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:solid 1px #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;-webkit-border-radius:4px;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;-webkit-border-radius:3px;border-radius:3px;-webkit-box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em white inset;box-shadow:0 1px 0 rgba(0,0,0,.2),0 0 0 .1em #fff inset;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin-left:auto;margin-right:auto;margin-top:0;margin-bottom:0;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:-ms-flexbox;display:-webkit-flex;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border-style:solid;border-width:1px;border-color:#e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;-webkit-border-radius:4px;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:rgba(255,255,255,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details>summary:first-of-type{cursor:pointer;display:list-item;outline:none;margin-bottom:.75em}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
table.tableblock #preamble>.sectionbody>[class="paragraph"]:first-of-type p{font-size:inherit}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border-style:solid;border-width:1px;border-color:#e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;-webkit-border-radius:4px;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border-style:solid;border-width:1px;border-color:#dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;-webkit-border-radius:4px;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{-webkit-border-radius:4px;border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class="highlight"],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;-webkit-border-radius:4px;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos{border-right:1px solid currentColor;opacity:.35;padding-right:.5em}
pre.pygments .lineno{border-right:1px solid currentColor;opacity:.35;display:inline-block;margin-right:.75em}
pre.pygments .lineno::before{content:"";margin-right:-.125em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all tr,table.stripes-odd tr:nth-of-type(odd),table.stripes-even tr:nth-of-type(even),table.stripes-hover tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
ol>li p,ul>li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
ul.checklist{margin-left:.625em}
ul.checklist li>p:first-child>.fa-square-o:first-child,ul.checklist li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist li>p:first-child>input[type="checkbox"]:first-child{margin-right:.25em}
ul.inline{display:-ms-flexbox;display:-webkit-box;display:flex;-ms-flex-flow:row wrap;-webkit-flex-flow:row wrap;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:solid 4px #fff;-webkit-box-shadow:0 0 0 1px #ddd;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
.gist .file-data>table{border:0;background:#fff;width:100%;margin-bottom:0}
.gist .file-data>table td.line-data{width:99%}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);-webkit-border-radius:50%;border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;-webkit-box-shadow:0 1px 4px #e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{-webkit-box-shadow:none!important;box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media print,amzn-kf8{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
<style>
pre.rouge table td { padding: 5px; }
pre.rouge table pre { margin: 0; }
pre.rouge .cm {
  color: #999988;
  font-style: italic;
}
pre.rouge .cp {
  color: #999999;
  font-weight: bold;
}
pre.rouge .c1 {
  color: #999988;
  font-style: italic;
}
pre.rouge .cs {
  color: #999999;
  font-weight: bold;
  font-style: italic;
}
pre.rouge .c, pre.rouge .ch, pre.rouge .cd, pre.rouge .cpf {
  color: #999988;
  font-style: italic;
}
pre.rouge .err {
  color: #a61717;
  background-color: #e3d2d2;
}
pre.rouge .gd {
  color: #000000;
  background-color: #ffdddd;
}
pre.rouge .ge {
  color: #000000;
  font-style: italic;
}
pre.rouge .gr {
  color: #aa0000;
}
pre.rouge .gh {
  color: #999999;
}
pre.rouge .gi {
  color: #000000;
  background-color: #ddffdd;
}
pre.rouge .go {
  color: #888888;
}
pre.rouge .gp {
  color: #555555;
}
pre.rouge .gs {
  font-weight: bold;
}
pre.rouge .gu {
  color: #aaaaaa;
}
pre.rouge .gt {
  color: #aa0000;
}
pre.rouge .kc {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kd {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kn {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kp {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kr {
  color: #000000;
  font-weight: bold;
}
pre.rouge .kt {
  color: #445588;
  font-weight: bold;
}
pre.rouge .k, pre.rouge .kv {
  color: #000000;
  font-weight: bold;
}
pre.rouge .mf {
  color: #009999;
}
pre.rouge .mh {
  color: #009999;
}
pre.rouge .il {
  color: #009999;
}
pre.rouge .mi {
  color: #009999;
}
pre.rouge .mo {
  color: #009999;
}
pre.rouge .m, pre.rouge .mb, pre.rouge .mx {
  color: #009999;
}
pre.rouge .sa {
  color: #000000;
  font-weight: bold;
}
pre.rouge .sb {
  color: #d14;
}
pre.rouge .sc {
  color: #d14;
}
pre.rouge .sd {
  color: #d14;
}
pre.rouge .s2 {
  color: #d14;
}
pre.rouge .se {
  color: #d14;
}
pre.rouge .sh {
  color: #d14;
}
pre.rouge .si {
  color: #d14;
}
pre.rouge .sx {
  color: #d14;
}
pre.rouge .sr {
  color: #009926;
}
pre.rouge .s1 {
  color: #d14;
}
pre.rouge .ss {
  color: #990073;
}
pre.rouge .s, pre.rouge .dl {
  color: #d14;
}
pre.rouge .na {
  color: #008080;
}
pre.rouge .bp {
  color: #999999;
}
pre.rouge .nb {
  color: #0086B3;
}
pre.rouge .nc {
  color: #445588;
  font-weight: bold;
}
pre.rouge .no {
  color: #008080;
}
pre.rouge .nd {
  color: #3c5d5d;
  font-weight: bold;
}
pre.rouge .ni {
  color: #800080;
}
pre.rouge .ne {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nf, pre.rouge .fm {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nl {
  color: #990000;
  font-weight: bold;
}
pre.rouge .nn {
  color: #555555;
}
pre.rouge .nt {
  color: #000080;
}
pre.rouge .vc {
  color: #008080;
}
pre.rouge .vg {
  color: #008080;
}
pre.rouge .vi {
  color: #008080;
}
pre.rouge .nv, pre.rouge .vm {
  color: #008080;
}
pre.rouge .ow {
  color: #000000;
  font-weight: bold;
}
pre.rouge .o {
  color: #000000;
  font-weight: bold;
}
pre.rouge .w {
  color: #bbbbbb;
}
pre.rouge {
  background-color: #f8f8f8;
}
</style>
</head>
<body class="article">
<div id="header">
<h1>Introducción a Infraestructura como Código (IaC)</h1>
<div class="details">
<span id="author" class="author">Miguel Barajas</span><br>
<span id="email" class="email"><a href="mailto:migbarajas@gmail.com">migbarajas@gmail.com</a></span><br>
<span id="revnumber">version 1.0,</span>
<span id="revdate">2021</span>
</div>
<div id="toc" class="toc">
<div id="toctitle">Contenido</div>
<ul class="sectlevel1">
<li><a href="#_dedicación">Dedicación</a></li>
<li><a href="#_prefacio">Prefacio</a>
<ul class="sectlevel2">
<li><a href="#_por_qué_escribí_este_libro">¿Por qué escribí este libro?</a></li>
<li><a href="#_por_qué_debería_de_leer_este_libro">¿Por qué debería de leer este libro?</a></li>
<li><a href="#_convenciones_usadas_en_este_libro">Convenciones usadas en este libro</a></li>
<li><a href="#_recursos_en_linea">Recursos en linea</a></li>
<li><a href="#_cómo_contactarme">¿Cómo contactarme?</a></li>
<li><a href="#_copia_este_libro">COPIA ESTE LIBRO</a></li>
</ul>
</li>
<li><a href="#_capítulo_1_introducción">Capítulo 1. Introducción</a>
<ul class="sectlevel2">
<li><a href="#_automatización_de_infraestructura">Automatización de Infraestructura</a></li>
<li><a href="#_manejadores_de_configuración">Manejadores de configuración</a></li>
<li><a href="#_el_crecimiento_de_la_popularidad_de_iac">El crecimiento de la popularidad de IaC</a></li>
</ul>
</li>
<li><a href="#_capítulo_2_caso_de_estudio">Capítulo 2. Caso de estudio</a></li>
<li><a href="#_capítulo_3_introducción_a_terraform">Capítulo 3. Introducción a Terraform</a>
<ul class="sectlevel2">
<li><a href="#_características">Características</a></li>
<li><a href="#_casos_de_uso">Casos de uso</a></li>
<li><a href="#_instalación_de_terraform">Instalación de <em>Terraform</em></a></li>
<li><a href="#_contrucción_de_infraestructura">Contrucción de Infraestructura</a></li>
<li><a href="#_cambios_a_la_infraestructura">Cambios a la Infraestructura</a></li>
</ul>
</li>
<li><a href="#_capítulo_4_introducción_a_packer">Capítulo 4. Introducción a Packer</a>
<ul class="sectlevel2">
<li><a href="#_características_2">Características</a></li>
<li><a href="#_casos_de_uso_2">Casos de uso</a></li>
<li><a href="#_instalación_de_packer">Instalación de <em>Packer</em></a></li>
<li><a href="#_construcción_de_imágenes">Construcción de imágenes</a></li>
<li><a href="#_desplegar_imagenes_de_packer_con_terraform">Desplegar imagenes de Packer con Terraform</a></li>
</ul>
</li>
<li><a href="#_creación_y_configuración_de_una_cuenta_de_amazon_web_services">Apéndice A: Creación y configuración de una cuenta de <em>Amazon Web Services</em></a></li>
<li><a href="#_glosario">Glosario</a></li>
<li><a href="#_bibliografía">Bibliografía</a></li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_dedicación">Dedicación</h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_prefacio">Prefacio</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_por_qué_escribí_este_libro">¿Por qué escribí este libro?</h3>
<div class="paragraph">
<p>Una gran parte de mi carrera profesional la he dedicado a la automatización y orquestación. Es un tema que me apasiona, sin embargo, la automatización "tradicional" cada vez se ha convertido en un <em>break and fix</em>. Es estática y requiere mucho esfuerzo mantener los flujos de trabajo, integraciones y <em>scripts</em> para que la automatización se siga dando en un mundo tan dinámico como el que vivimos en las tecnologías de la información. Desde el primer momento que descubrí los manejadores de configuración, quedé enamorado. En los tiempos de <strong><em>CFENGINE</em></strong> hacíamos cosas maravillosas que nos permitían enforcarnos realmente a la arquitectura y estrategía en vez de estar configurando pequeñas aplicaciones distribuidas una por una. Podíamos replicar cambios en miles de equipos en un momento. Luego tuve oportunidad de trabajar con <strong><em>Chef</em></strong> y <strong><em>Puppet</em></strong>, los cuales son excelentes manejadores de configuración, pero no fue hasta que <strong><em>Ansible</em></strong> llegó con una forma clara y estandarizada de escribir las configuraciones, que el tema realmente empezó a despegar. Las configuraciones de <em>Ansible</em> están echas en <strong><em>YAML</em></strong> <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup> Esto permite que sean claramente <em>leíbles</em> por un humano.</p>
</div>
<div class="paragraph">
<p>El tema con <em>Ansible</em> es que fue concebido como un manejador de configuraciones para Sistemas Operativos y aplicaciones, pero faltaba una parte: <strong>La Infraestructura</strong>. No teníamos forma de tratar la configuración de la infraestructura de la misma manera que tratábamos la del sistema operativo o la aplicación. Es ahí donde <em>Terraform</em> brilla, es una herramienta orientada justo a esto último, lo cual facilita meter a la infraestructura en el proceso de <strong><em>CI/CD</em></strong> <sup class="footnote">[<a id="_footnoteref_2" class="footnote" href="#_footnotedef_2" title="View footnote.">2</a>]</sup>.</p>
</div>
</div>
<div class="sect2">
<h3 id="_por_qué_debería_de_leer_este_libro">¿Por qué debería de leer este libro?</h3>

</div>
<div class="sect2">
<h3 id="_convenciones_usadas_en_este_libro">Convenciones usadas en este libro</h3>

</div>
<div class="sect2">
<h3 id="_recursos_en_linea">Recursos en linea</h3>

</div>
<div class="sect2">
<h3 id="_cómo_contactarme">¿Cómo contactarme?</h3>

</div>
<div class="sect2">
<h3 id="_copia_este_libro">COPIA ESTE LIBRO</h3>
<div class="paragraph">
<p>¡Sí, copia este libro! Úsalo para cualquier fin, auméntalo, regálalo. Este libro está bajo la licencia CC</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_capítulo_1_introducción">Capítulo 1. Introducción</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Para entender la infraestructura como código (IaC por sus siglas en inglés) primero debemos entender qué es infraestructura y qué es código. Infraestructura en el contexto de informática, es el hardware, físico, virtual o lógico que soporta una aplicación o plataforma. Del mismo modo, el código son las instrucciones que permiten crear una aplicación o software. Luego entonces, la infraestructura como código, es la descripción del estado deseado de la configuración de esta infraestructura en un documento, normalmente escrito en texto plano. Al estar escrito en texto plano, esta descripción puede tratarse de la misma manera que se trata un código de software, donde podemos versionarlo, probarlo, compartirlo, etc.</p>
</div>
<div class="paragraph">
<p>Para hacer esto realidad, debemos contar con un intermediario o intérprete que comprenda esta descripción y la convierta en una configuración que sea entendida por la infraestructura. Esto nos permite automatizar la infraestructura de tal manera que esa configuración la tratemos como software, esto nos da varias ventajas que estaremos discutiendo durante la presente obra, algunas de ellas son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Automatización declarativa en vez de imperativa</p>
</li>
<li>
<p>Versionamiento de la configuración</p>
</li>
<li>
<p>Replicación sencilla</p>
</li>
<li>
<p><strong>ESCRIBIR MAS</strong></p>
</li>
</ul>
</div>
<div class="sect2">
<h3 id="_automatización_de_infraestructura">Automatización de Infraestructura</h3>
<div class="paragraph">
<p>La automatización de la infraestructura no es un tema nuevo, es una prácica que existe hace décadas. Dado a la necesidad de hacer más eficiente el despliegue de esta infraestructura, esto se hace mediante <strong><em>scripts</em></strong> o desarrollos que permiten que esta infraestructura se despliegue automáticamente, el problema con este acercamiento, es que no solo le tenemos que planear qué se va a desplegar, si no tambien cómo se desplegará, por lo que es una automatización <strong>imperativa</strong>. Esto nos acarrea un problema dado que muchas veces la infraestructura no puede ser cambiada una vez desplegada, puesto que en la automatización debemos tener en cuenta todas las excepciones que pudieran ocurrir durante el ciclo de vida de la infraestructura. Por ende, la automatización imperativa funciona muy bien solo para el despliegue de nueva infraestructura, pero no para mantener el ciclo de vida completa de ella. Es decir, despliegue, cambios y decomización.</p>
</div>
<div class="paragraph">
<p>Más allá de la automatización, existe el concepto de <strong><em>orquestación</em></strong> en el que normalmente existe un software llamado <strong>orquestador</strong> (<strong><em>orchestrator</em></strong> en inglés) el cual cuenta con los conectores necesarios para automatizar el despliegue de las diferentes capas de la infraestructura: Almacenamiento, Red, Computo, Sistema Operativo, etc).</p>
</div>
<div class="paragraph">
<p>Esto permite "orquestrar" el despliegue de la pila completa de la infraestructura. Pero de la misma manera que se hace al automatizar de manera imperativa, capa por capa, la orquestación imperativa no permite manejar el ciclo de vida completo de la infraestructura.</p>
</div>
</div>
<div class="sect2">
<h3 id="_manejadores_de_configuración">Manejadores de configuración</h3>
<div class="paragraph">
<p>Los manejadores de configuración, han existido, de igual manera, desde hace décadas, son piezas de software que nos permiten mantener la configuración de un sistema operativo o aplicación de manera declarativa. Es decir, en vez de indicar el qué y el cómo, se describe el qué, es decir se declara el estado deseado de la configuración del Sistema Operativo o aplicación y es el manejador de configuración quien hace la conciliación entre el estado declarado y el estado actual. Es decir, que solo modifica las partes de la configuración que no concuerdan con el estado deseado. Como se manifestó, los Manejadores de configuración (<strong><em>Configuration Manager</em></strong> en inglés) fueron concebidos para mantener la configuración del Sistema Operativo y/o la aplicación. Con el avance de las tecnologías de virtualización y del concepto de <strong><em>Software Defined</em></strong>, el despliegue y configuración de la infraestructura, también puede ser declarada y manejada como si de un sistema operativo o una aplicación se tratara.</p>
</div>
</div>
<div class="sect2">
<h3 id="_el_crecimiento_de_la_popularidad_de_iac">El crecimiento de la popularidad de IaC</h3>
<div class="paragraph">
<p>Sin duda, la adopción del <strong><em>Cloud Computing</em></strong> ha permitido que la IaC se haya popularizado. La disponibilización de las interfaces de programabilidad (APIs), así como el cobro por tiempo utilizado de la infraestructura, han hecho que l IaC sea muy popular para este tipo de modelos de consumo. Sin embargo, también ha influenciado a los fabricantes de infraestructura física, y estos han empezado a disponibilizar <em>APIs</em>, así como también han separado el plano de control del plano de datos, que es el principio del <em>hardware</em> definido por <em>software</em>. Empresas como <strong><em>Hashicorp</em></strong> han creado soluciones de IaC que estaremos usando en esta obra, que lleva por nombre <strong><em>Terraform</em></strong>. Terraform es una herramienta de código abierto para infraestructura como código que provee un flujo de trabajo por linea de comandos consistente para manejar cientos de servicios de nube. Terraform codifica las <em>APIs</em> de las nubes en archivos de configuración declarativa. <sup class="footnote">[<a id="_footnoteref_3" class="footnote" href="#_footnotedef_3" title="View footnote.">3</a>]</sup></p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_capítulo_2_caso_de_estudio">Capítulo 2. Caso de estudio</h2>
<div class="sectionbody">
<div class="paragraph">
<p>A través de este libro estaremos creando los bloques necesarios para mantener la operación de una aplicación mantenida en la nube, la cual cuenta con varios elementos de infraestructura que definiremos como código. La idea de este caso de estudio, será que podamos desplegar esta aplicación, modificarla, escalarla, decomisarla, cambiarla de una región a otra, etc.</p>
</div>
<div class="paragraph">
<p>El caso de estudio será de la empresa imaginaria de repostería "Galletería Carlota" la cual mantiene su sistema de tienda en linea en la <strong><em>Amazon Web Service</em></strong> o <strong><em>AWS</em></strong> como le llamaremos de aquí en adelante. La arquitectura propuesta para la aplicación tiene varias capas o niveles como se muestra en la siguiente figura:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Tres (3) Balanceador de Carga nativos de <em>AWS</em> para la capas de presentación, aplicación y base de datos.</p>
</li>
<li>
<p>Una <strong>Capa de Presentación <em>web</em></strong> que permite ser escalada verticalmente.</p>
</li>
<li>
<p>Las imágenes de los productos a vender serán almacenadas en un <em>S3 Bucket</em>.</p>
</li>
<li>
<p>Una <strong>Capa de Aplicación</strong> que será donde se procese la logíca de negocio la cual tambien debe ser verticalmente escalable.</p>
</li>
<li>
<p>Una <strong>Capa de Base de Datos</strong>, la cual es nativa a la nube y permite ser escalada verticalmente, en este caso usaremos <em>CoackroachDB</em>.</p>
</li>
</ul>
</div>
<div class="imageblock">
<div class="content">
<img src="imagenes/App-Arch-Aws.png" alt="App Arch Aws">
</div>
<div class="title">Imagen 1. Arquitectura de la Aplicación en AWS</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_capítulo_3_introducción_a_terraform">Capítulo 3. Introducción a Terraform</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Como ya se platicó en el Capítulo 1, durante el desarrollo de esta obra estaremos utilizando la versión abierta y gratuita de <strong><em>Hashicorp Terraform</em></strong>, la cual ha tomado mucha popularidad entre intenieros que hacen <strong><em>DEVOPS</em></strong> y <strong><em>CI/CD</em></strong>, temas que trataremos más adelante. Y no es casualidad, <em>Terraform</em> ofrece un entorno bien documentado y con cientos de integraciones que permiten a las organizaciones tratar su infraestructura como código al escribir archivos con la declaración del estado deseado de las configuraciones. <em>Terraform</em> usa su propio lenguage llamado <strong><em>Hashicorp Configuration Language (HLC)</em></strong> que permite una descripción concisa de los recursos usando bloques de código, argumentos y expresiones.</p>
</div>
<div class="paragraph">
<p>De la misma manera, <em>Terraform</em> permite correr las verificaciones necesarias antes de aplicar las configuraciones deseadas para asegurarse que los cambios a realizar son factibles, y el operador tiene oportunidad de entender qué cambios sucederán y como afectará el ambiente desplegado. Una vez hecho esto, el operador puede proceder a aplicar los cambios, para poder llegar al estado deseado solo modificando el delta entre el estado actual y el deseado.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta introducción, casi en su totalidad es una traducción simple de la documentación oficial de Hashicorp <a href="#intro_terraform">[intro_terraform]</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="title">Código Ejemplo escrito en HCL para AWS</div>
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">variable <span class="s2">"ami_id"</span> <span class="o">{</span>
  <span class="nb">type</span>        <span class="o">=</span> string
  description <span class="o">=</span> <span class="s2">"AMI ID to use"</span>
  default     <span class="o">=</span> <span class="s2">"ami-09d95fab7fff3776c"</span>
<span class="o">}</span>

variable <span class="s2">"instance_type"</span> <span class="o">{</span>
  <span class="nb">type</span>        <span class="o">=</span> string
  description <span class="o">=</span> <span class="s2">"Instance type to use"</span>
  default     <span class="o">=</span> <span class="s2">"t3.micro"</span>
<span class="o">}</span>

variable <span class="s2">"availability_zone"</span> <span class="o">{</span>
  <span class="nb">type</span>        <span class="o">=</span> string
  description <span class="o">=</span> <span class="s2">"Availability Zone to use"</span>
  default     <span class="o">=</span> <span class="s2">"us-east-1a"</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_características">Características</h3>
<div class="paragraph">
<p>Algunas de las características más importantes de <em>Terraform</em> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Archivos de Configuración Declarativa:</strong> Definición de Infraestructura como Código para manejar el ciclo de vida completo, creación de nuevos recursos, manejo de los existentes así como la decomisación cuando estos ya no son necesarios.</p>
</li>
<li>
<p><strong>Modulos instalables:</strong> Intalación automática de modulos de la comunidad o terceros desde el registro de <em>Hashicorp</em> por medio de <code>terraform init</code>.</p>
</li>
<li>
<p><strong>Planeación y predicción de cambios:</strong> <em>Terraform</em> permite a los operadores hacer cambios a la infraestructura de manera segura y predectible.</p>
</li>
<li>
<p>*Graficación de dependencias</p>
</li>
<li>
<p><strong>Manejo del estado:</strong> Mapeo de la configuración de los recursos del mundo real, mantenimiento de los <em>metadatos</em> y mejoramiento del <em>performance</em> en infraestructuras grandes</p>
</li>
<li>
<p><strong>Registro de más de 500 proveedores:</strong> El operador puede escoger de una serie de proveedores para las diferentes plataformas de nube disponibles en el mercado.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_casos_de_uso">Casos de uso</h3>
<div class="paragraph">
<p>Algunos de los casos de uso que se pueden cubrir con terraform son: <sup class="footnote">[<a id="_footnoteref_4" class="footnote" href="#_footnotedef_4" title="View footnote.">4</a>]</sup></p>
</div>
<div class="ulist">
<ul>
<li>
<p>Despliegue de aplicaciones en <em>Heruku</em>.</p>
</li>
<li>
<p>Aplicaciones Multi Capa. <sup class="footnote">[<a id="_footnoteref_5" class="footnote" href="#_footnotedef_5" title="View footnote.">5</a>]</sup></p>
</li>
<li>
<p><em>Clusteres</em> de Autoservicio.</p>
</li>
<li>
<p>Demostraciones de <em>Software</em>.</p>
</li>
<li>
<p>Ambientes deshechables.</p>
</li>
<li>
<p>Despliegues multi nube.</p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_instalación_de_terraform">Instalación de <em>Terraform</em></h3>
<div class="paragraph">
<p>En esta sección estaremos discutiendo la instalación del binario de <em>Terraform</em> en nuestro equipo personal, donde crearemos un ambiente de desarrollo para escribir, probar y desplegar nuestra infraestructura. Existen varios métodos para la instalación de <em>Terraform</em> a continuación discutiremos los más importantes.</p>
</div>
<div class="sect3">
<h4 id="_instalación_manual">Instalación Manual</h4>
<div class="paragraph">
<p>Para la instalación manual de <em>Terraform</em>, necesitamos encontrar el paquete apropiado <sup class="footnote">[<a id="_footnoteref_6" class="footnote" href="#_footnotedef_6" title="View footnote.">6</a>]</sup> para nuestro sistema operativo y bajarlo, este será un archivo <em>zip</em>.</p>
</div>
<div class="paragraph">
<p>Una vez que se haya bajado <em>Terraform</em>, procederemos a expander el archivo <em>zip</em>. Encontraremos que es un solo binario llamado <code>terraform</code>. Todos los demás archivos que pudiera contener el archivo <em>zip</em> pueden ser borrados de manera segura sin que esto afecte el funcionamiento de <em>Terraform</em>.</p>
</div>
<div class="paragraph">
<p>Finalmente, nos aseguraremos de que <code>terraform</code> se encuentre disponible en nuestro <code>PATH</code>. Esto se realiza de manera diferente, dependiendo el sistema operativo.</p>
</div>
<div class="sect4">
<h5 id="_mac_o_linux">Mac o Linux</h5>
<div class="paragraph">
<p>Obtenemos la lista de rutas que están disponibles en la variable de entorno <code>PATH</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="nb">echo</span> $PATH</code></pre>
</div>
</div>
<div class="paragraph">
<p>Movemos el binario te <em>Terraform</em> a uno de las rutas listadas. Este comando asume que el binario se encuentra en el archivo de descargas y que <code>PATH</code> contiene <code>/usr/local/bin</code>, personaliza en caso de las rutas en tu sistema operativo sean diferentes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">mv</span> <span class="o">~</span><span class="na">/Downloads/terraform /usr/local/bin</span>/</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_windows">Windows</h4>
<div class="paragraph">
<p>En la siguiente dirección de internet, podemos encontrar las instrucciones exactas para modificar el <code>PATH</code> en <em>Windows</em> através de la interfaz gráfica: <code><a href="https://stackoverflow.com/questions/1618280/where-can-i-set-path-to-make-exe-on-windows" class="bare">https://stackoverflow.com/questions/1618280/where-can-i-set-path-to-make-exe-on-windows</a></code></p>
</div>
</div>
<div class="sect3">
<h4 id="_instalación_con_homebrew_en_macos">Instalación con <em>Homebrew</em> en <em>MacOS</em></h4>
<div class="paragraph">
<p><em>Homebrew</em> es un manejador de paquetes de fuente abierta para el sistema operativo <em>MacOS</em>. Instala la <em>formula</em> oficial de <em>Terraform</em> desde la terminal.</p>
</div>
<div class="paragraph">
<p>Primero, installamos el <em>tap</em> de <em>HashiCorp</em>, un repositorio para todos los paquetes de <em>Homebrew</em> de la compañia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">brew</span> <span class="kd">tap</span> <span class="kd">hashicorp</span><span class="na">/tap</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora, Instalamos <em>Terraform</em> con <code>hashicorp/tap/terraform</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">brew</span> <span class="kd">install</span> <span class="kd">hashicorp</span><span class="na">/tap/terraform</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para actualizar a la última versión, ejecutamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">brew</span> <span class="kd">upgrade</span> <span class="kd">hashicorp</span><span class="na">/tap/terraform</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_instalación_con_chocolatey_en_windows">Instalación con <em>Chocolatey</em> en <em>Windows</em></h4>
<div class="paragraph">
<p><em>Chocolatey</em> es un manejador de paquetes de codigo abierto para <em>Windows</em>. Installamos el paquete de <em>Terraform</em> desde la linea de comandos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">choco</span> <span class="kd">install</span> <span class="kd">terraform</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_instalación_en_linux">Instalación en Linux</h4>
<div class="sect4">
<h5 id="_ubuntudebian">Ubuntu/Debian</h5>
<div class="paragraph">
<p>Agregamos la llave <em>GPG</em> de <em>HashiCorp</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="nb">curl</span> <span class="na">-fsSL </span><span class="kd">https</span>://apt.releases.hashicorp.com/gpg <span class="o">|</span> <span class="kd">sudo</span> <span class="kd">apt</span><span class="na">-key </span><span class="kd">add</span> <span class="o">-</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Agregamos los repositorios oficiales de <em>HashiCorp</em> para <em>Linux</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">apt</span><span class="na">-add-repository </span><span class="s2">"deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Actualización e instalación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">apt</span><span class="na">-get </span><span class="kd">update</span> <span class="o">&amp;&amp;</span> <span class="kd">sudo</span> <span class="kd">apt</span><span class="na">-get </span><span class="kd">install</span> <span class="kd">terraform</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_centosrhel">CentOS/RHEL</h5>
<div class="paragraph">
<p>Instalamos <code>yum-config-manager</code> para manejar repositorios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">yum</span> <span class="kd">install</span> <span class="na">-y </span><span class="kd">yum</span><span class="na">-utils</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Usamos <code>yum-config-manager</code> para agregar el repositorio oficial de <em>HachiCorp</em> para <em>Linux</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">yum</span><span class="na">-config-manager --add-repo </span><span class="kd">https</span>://rpm.releases.hashicorp.com/RHEL/hashicorp.repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instalamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">yum</span> <span class="na">-y </span><span class="kd">install</span> <span class="kd">terraform</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fedora">Fedora</h5>
<div class="paragraph">
<p>Instalamos <code>dnf config-manager</code> para manejar repositorios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">dnf</span> <span class="kd">install</span> <span class="na">-y </span><span class="kd">dnf</span><span class="na">-plugins-core</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Usamos <code>dnf config-manager</code> para agregar el repositorio oficial de <em>HachiCorp</em> para <em>Linux</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">dnf</span> <span class="kd">config</span><span class="na">-manager --add-repo </span><span class="kd">https</span>://rpm.releases.hashicorp.com/fedora/hashicorp.repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instalamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">dnf</span> <span class="na">-y </span><span class="kd">install</span> <span class="kd">terraform</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_verificación_de_la_instalación">Verificación de la instalación.</h4>
<div class="paragraph">
<p>Para verificar la instalación abrimos una nueva terminal y ejecutamos <code>terraform -help</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">terraform</span> <span class="na">-help
</span><span class="kd">Usage</span>: <span class="kd">terraform</span> <span class="o">[</span><span class="kd">global</span> <span class="kd">options</span><span class="o">]</span> <span class="o">&lt;</span><span class="kd">subcommand</span><span class="o">&gt;</span> <span class="o">[</span><span class="kd">args</span><span class="o">]</span>

<span class="kd">The</span> <span class="kd">available</span> <span class="kd">commands</span> <span class="k">for</span> <span class="kd">execution</span> <span class="kd">are</span> <span class="kd">listed</span> <span class="kd">below</span>.
<span class="kd">The</span> <span class="kd">primary</span> <span class="kd">workflow</span> <span class="kd">commands</span> <span class="kd">are</span> <span class="kd">given</span> <span class="kd">first</span><span class="o">,</span> <span class="kd">followed</span> <span class="kd">by</span>
<span class="kd">less</span> <span class="kd">common</span> <span class="kd">or</span> <span class="nb">more</span> <span class="kd">advanced</span> <span class="kd">commands</span>.
...</code></pre>
</div>
</div>
<div class="paragraph">
<p>Cualquier sub comando despues de <code>terraform -help</code> permite aprender más sobre el mismo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">terraform</span> <span class="na">-help </span><span class="kd">plan</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto finalizamos la instalación de <em>Terraform</em> y estamos listos para empezar a construir infraestructura como código.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_contrucción_de_infraestructura">Contrucción de Infraestructura</h3>
<div class="paragraph">
<p>Con <em>Terraform</em> installado, estamos listos para crear nuestra primera infraestructura.</p>
</div>
<div class="paragraph">
<p>Vamos a aprovisionar una <strong><em>Amazon Machine Image (AMI)</em></strong> en <strong><em>AWS</em></strong> esto lo haremos de esta manera, dado que las <em>AMIs</em> son muy populares.</p>
</div>
<div class="sect3">
<h4 id="_pre_requisitos">Pre requisitos</h4>
<div class="paragraph">
<p>Para continuar, necesitamos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una cuenta de <em>AWS</em></p>
</li>
<li>
<p>La intefaz de linea de comando de <em>AWS</em></p>
</li>
<li>
<p>Las credenciales de <em>AWS</em> configuradas localmente</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Esto está descrito en el Apéndice <a href="#">Creación y configuración de una cuenta de Amazon Web Services</a></p>
</div>
</div>
<div class="sect3">
<h4 id="_escribir_configuraciones">Escribir configuraciones</h4>
<div class="paragraph">
<p>El conjunto de archivos usado para describir la infraestructura en <em>Terraform</em> es conocido como <em>Terraform Configuration</em>. Vamos a escribir nuestra primera configuración ahora para lanzar una instancia de <em>EC2 de AWS</em>.</p>
</div>
<div class="paragraph">
<p>Cada configuración debe estar en su propio directorio. Crearemos un directorio para esta nueva configuración.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">mkdir </span>iac-libro-aws-instancia</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos cambiamos al directorio recién creado</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nb">cd </span>iac-libro-aws-instancia</code></pre>
</div>
</div>
<div class="paragraph">
<p>Pegamos la configuración que está a continuación dentro de un archivo que tenga por nombre <code>ejemplo.tf</code> y lo guardamos. <em>Terraform</em> carga todos los archivos en el directorio actual que tengan la extención <code>.tf</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">terraform <span class="o">{</span>
  required_providers <span class="o">{</span>
    aws <span class="o">=</span> <span class="o">{</span>
      <span class="nb">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      version <span class="o">=</span> <span class="s2">"~&gt; 2.70"</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

provider <span class="s2">"aws"</span> <span class="o">{</span>
  profile <span class="o">=</span> <span class="s2">"default"</span>
  region  <span class="o">=</span> <span class="s2">"us-west-2"</span>
<span class="o">}</span>

resource <span class="s2">"aws_instance"</span> <span class="s2">"ejemplo"</span> <span class="o">{</span>
  ami           <span class="o">=</span> <span class="s2">"ami-830c94e3"</span>
  instance_type <span class="o">=</span> <span class="s2">"t2.micro"</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esta es una configuración completa de <em>Terraform</em> y está lista para ser aplicada. En las siguientes secciones, veremos como funciona cada uno de estos bloques en más detalle.</p>
</div>
<div class="sect4">
<h5 id="_bloques_de_terraform">Bloques de <em>Terraform</em></h5>
<div class="paragraph">
<p>El bloque <code>terraform {}</code> es requerido para que <em>Terraform</em> conozca qué proveedor tiene que descargar desde el registro de <em>Terraform</em>. En la configuración anterior, el proveedor <code>aws</code> está definido como <code>hashicorp/aws</code> que es una abreviación de <code>redistry.terraform.io/hashicorp/aws</code>.</p>
</div>
<div class="paragraph">
<p>También podemos asignar una versión definida en el bloque <code>required_providers</code>. El argumento <code>version</code> es opcional, pero recomendado.</p>
</div>
</div>
<div class="sect4">
<h5 id="_proveedores">Proveedores</h5>
<div class="paragraph">
<p>El bloque <code>provider</code> configura el nombre del proveedor, en nuestro caso <code>aws</code>, que es responsable de crear y manejar los recursos. Un proveedor es un <em>plugin</em> que <em>Terraform</em> usa para traducir las interacciones con las <em>API</em> del servicio a administrar. Un proveedor es el responsable por entender tales interacciones y exponer los recursos. Por el hecho de que <em>Terraform</em> puede interactuar con cualquier <em>API</em>, podemos representar casi cualquier tipo de infraestructura como recursos en <em>Terraform</em>.</p>
</div>
<div class="paragraph">
<p>El atributo <code>profile</code> en nuestro bloque de proveedor se refiere, en este caso, a las credenciales de <em>AWS</em> almacenadas en la el archivo de configuración de <em>AWS</em>, que se creó cuando se hizo la configuración del <em>CLI</em> de <em>AWS</em>. La mejor práctica recomendada, es que no se use credenciales directamente en los archivos <code>.tf</code>.</p>
</div>
<div class="paragraph">
<p>Pueden existir múltiples bloques de proveedor en caso de ser necesario. Podemos, incluso, usar múltiples proveedores juntos. Por ejemplo, podemos pasar el identificador de una intancia de <em>AWS</em> para monitorear tal recurso con <em>DataDog</em>.</p>
</div>
</div>
<div class="sect4">
<h5 id="_recursos">Recursos</h5>
<div class="paragraph">
<p>El bloque de <code>resources</code> define una pieza de la infraestructura. Un recurso puede er un componente físico o virtual como una instancia de <em>EC2</em>, o puede ser un recurso lógico como una <em>IP elástica</em>.</p>
</div>
<div class="paragraph">
<p>El bloque de recursos tiene dos entradas antes del bloque como tal: el tipo de recurso y el nombre del recurso. en este ejemplo, el tipo de recurso es <code>aws_instance</code> y el nombre es <code>ejemplo</code>. El prefijo en el tipo de recurso se mapea al proveedor. En nuestro caso <code>aws_instance</code> automáticamente le dice a <em>Terraform</em> que este será manejado por el proveedor <em>aws</em>.</p>
</div>
<div class="paragraph">
<p>Los argumentos del recurso están dentro del bloque del recurso. Los artumentos pueden ser cosas como el tamaño de la máquina, el nombre de la imagen del disco, o identificadores del <em>VPC</em> donde se desplegará la instancia. Para entender los argumentos opcionales y requeridos de cada tipo de recurso, es necesario consultar los documentos de referencia de <em>HashiCorp</em> <sup class="footnote">[<a id="_footnoteref_7" class="footnote" href="#_footnotedef_7" title="View footnote.">7</a>]</sup>. En el caso de la instancia de <em>EC2</em> que crearemos, especificamos un <em>AMI</em> para <em>Ubuntu</em> y el tamaño requerido será <code>t2.micro</code> que califica como <em>free tier</em> en nuestra cuenta de <em>AWS</em>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_inicializando_el_directorio">Inicializando el directorio</h4>
<div class="paragraph">
<p>Cuando creamos una nueva configuración (o hacemos <em>checkout</em> de una configuración existente desde el control de versiones) necesitamos inicializar el directorio con <code>terrarom init</code>.</p>
</div>
<div class="paragraph">
<p><em>Terraform</em> usa una arquitectura basada en <em>plugins</em> que soporta cientos de proveedores de servicios de infraestructura. Inicializar un directorio de configuracion, descarga e instala los proveedores usados en la configuración qué, en este caso, es el proveedor <code>aws</code>. Los comandos subsecuentes, usarán los datos y configuraciones locales hechos durante la inicialización.</p>
</div>
<div class="paragraph">
<p>Iniciemos el directorio.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>terraform init

Initializing the backend...

Initializing provider plugins...
- Finding hashicorp/aws versions matching <span class="s2">"~&gt; 2.70"</span>...
- Installing hashicorp/aws v2.70.0...
- Installed hashicorp/aws v2.70.0 <span class="o">(</span>signed by HashiCorp<span class="o">)</span>

Terraform has created a lock file .terraform.lock.hcl to record the provider
selections it made above. Include this file <span class="k">in </span>your version control repository
so that Terraform can guarantee to make the same selections by default when
you run <span class="s2">"terraform init"</span> <span class="k">in </span>the future.

Terraform has been successfully initialized!

You may now begin working with Terraform. Try running <span class="s2">"terraform plan"</span> to see
any changes that are required <span class="k">for </span>your infrastructure. All Terraform commands
should now work.

If you ever <span class="nb">set </span>or change modules or backend configuration <span class="k">for </span>Terraform,
rerun this <span class="nb">command </span>to reinitialize your working directory. If you forget, other
commands will detect it and remind you to <span class="k">do </span>so <span class="k">if </span>necessary.</code></pre>
</div>
</div>
<div class="paragraph">
<p><em>Terraform</em> descarga el proveedor <code>aws</code> y lo instala en un subdirectorio oculto en el directorio actual. La salida muestra la versión del plugin que fue instalada.</p>
</div>
</div>
<div class="sect3">
<h4 id="_formato_y_validación_de_la_configuración">Formato y validación de la configuración</h4>
<div class="paragraph">
<p>Una mejor práctica es usar un formato consistente en los archivos y módulos escritos por diferentes equipos. El comando <code>terraform fmt</code> automáticamente actualiza la configuración en el directorio actual para una mejor lectura y consistencia.</p>
</div>
<div class="paragraph">
<p>Formatearemos nuestra configuración. <em>Terraform</em> retornará los nombres de los archivos formateados. En este caso, nuestro archivo de configuración está de por sí formateado de manera correcta, es por eso que <em>Terraform</em> no retornará ningún nombre de archivo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>terraform <span class="nb">fmt</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para validar que la configuración es sintáctimanete válida usamos el comando <code>terraform validate</code>. Si nuestra configuración es válida <em>Terraform</em> retornará un mensaje exitoso.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>terraform validate
Success! The configuration is valid.</code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_creación_de_infraestructura">Creación de Infraestructura</h4>
<div class="paragraph">
<p>En el mismo directorio donde se encuentra <code>ejemplo.tf</code> corremos <code>terraform apply</code>. Debes ver una salida similar a la mostrada a continuación:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">terraform apply

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
  + create

Terraform will perform the following actions:

  <span class="c"># aws_instance.ejemplo will be created</span>
  + resource <span class="s2">"aws_instance"</span> <span class="s2">"ejemplo"</span> <span class="o">{</span>
      + ami                          <span class="o">=</span> <span class="s2">"ami-830c94e3"</span>
      + arn                          <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + associate_public_ip_address  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + availability_zone            <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + cpu_core_count               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + cpu_threads_per_core         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + get_password_data            <span class="o">=</span> <span class="nb">false</span>
      + host_id                      <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + <span class="nb">id</span>                           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + instance_state               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + instance_type                <span class="o">=</span> <span class="s2">"t2.micro"</span>
      + ipv6_address_count           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + ipv6_addresses               <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>

<span class="c">## ... Salida Omitida ...</span>

Plan: 1 to add, 0 to change, 0 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only <span class="s1">'yes'</span> will be accepted to approve.

  Enter a value:</code></pre>
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Si tu configuración falla al aplicarse, quizá debas personalizar la región usada o remover el VPC por default.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Esta salida nos muestra el plan de ejecución, describiendo qué acciones tomará <em>Terraform</em> para hacer los cambios en la infraestructura real para cumplir con el estado declarado en la configuración.</p>
</div>
<div class="paragraph">
<p>El formato de la salida es similar al formato de <em>diff</em> generado por herramientas como <em>Git</em>. La salida tiene un <code>+</code> junto a <code>aws_instance.ejemplo</code>, esto significa que <em>Terraform</em> creará este recurso. Debajo de esto, muestra los atributos que serán configurados. Cuando el valor desplegado es <code>known after apply</code>, significa que ese valor no será conocido hasta que el recurso no sea creado.</p>
</div>
<div class="paragraph">
<p><em>Terraform</em> quedará en pausa y esperará la aprobación de los cambios antes de proceder. Si algo del plan parece incorrecto o peligroso, podemos abortar de manera segura y ningún cambio será realizado en nuestra infraestructura.</p>
</div>
<div class="paragraph">
<p>Si el plan es aceptable, entonces escribimos <code>yes</code> en la entrada que nos pide confirmar para proceder. Ejecutar este plan tomará algunos minutos, dado que <em>Terraform</em> espera a que la Instancia <em>EC2</em> esté disponible.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">  Enter a value: <span class="nb">yes

</span>aws_instance.ejemplo: Creating...
aws_instance.ejemplo: Still creating... <span class="o">[</span>10s elapsed]
aws_instance.ejemplo: Still creating... <span class="o">[</span>20s elapsed]
aws_instance.ejemplo: Creation <span class="nb">complete </span>after 34s <span class="o">[</span><span class="nb">id</span><span class="o">=</span>i-0f57d1b36088f27ae]

Apply <span class="nb">complete</span><span class="o">!</span> Resources: 1 added, 0 changed, 0 destroyed.</code></pre>
</div>
</div>
<div class="paragraph">
<p>¡Hemos creado infraestructura hecha con Terraform! En este momento, podemos visitar la consola de <em>EC2</em> para confirmar que se haya creado la instancia. Para esto, hay que estar seguro que tengamos seleccionada la región que fue puesta en nuestra configuración del proveedor.</p>
</div>
</div>
<div class="sect3">
<h4 id="_inspección_del_estado">Inspección del estado.</h4>
<div class="paragraph">
<p>Cuando aplicamos la configuración, <em>Terraform</em> escribió datos en un rachivo llamado <code>terraform.tfstate</code>. Este archivo ahora contiene los identificadores y propiedades de los recursos que <em>Terraform</em> creó de tal manera que de ahora en adelante puede administrar y destruir los recursos.</p>
</div>
<div class="paragraph">
<p>Debemos guardar este archivo de manera segura y distribuirlo solo a los miembros confiables del equipo quienes necesiten manejar nuestra infraestructura. En producción, la mejor práctica es que se almacene este estado de manera remota.</p>
</div>
<div class="paragraph">
<p>Inspeccionemos el estado actual usando el comando <code>terraform show</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>terraform show
<span class="c"># aws_instance.ejemplo:</span>
resource <span class="s2">"aws_instance"</span> <span class="s2">"ejemplo"</span> <span class="o">{</span>
    ami                          <span class="o">=</span> <span class="s2">"ami-830c94e3"</span>
    arn                          <span class="o">=</span> <span class="s2">"arn:aws:ec2:us-west-2:561656980159:instance/i-0f57d1b36088f27ae"</span>
    associate_public_ip_address  <span class="o">=</span> <span class="nb">true
    </span>availability_zone            <span class="o">=</span> <span class="s2">"us-west-2c"</span>
    cpu_core_count               <span class="o">=</span> 1
    cpu_threads_per_core         <span class="o">=</span> 1
    disable_api_termination      <span class="o">=</span> <span class="nb">false
    </span>ebs_optimized                <span class="o">=</span> <span class="nb">false
    </span>get_password_data            <span class="o">=</span> <span class="nb">false
    </span>hibernation                  <span class="o">=</span> <span class="nb">false
    id</span>                           <span class="o">=</span> <span class="s2">"i-0f57d1b36088f27ae"</span>
    instance_state               <span class="o">=</span> <span class="s2">"running"</span>
    instance_type                <span class="o">=</span> <span class="s2">"t2.micro"</span>
    ipv6_address_count           <span class="o">=</span> 0
    ipv6_addresses               <span class="o">=</span> <span class="o">[]</span>
    monitoring                   <span class="o">=</span> <span class="nb">false
    </span>primary_network_interface_id <span class="o">=</span> <span class="s2">"eni-0b899ad3349b26177"</span>
    private_dns                  <span class="o">=</span> <span class="s2">"ip-172-31-7-180.us-west-2.compute.internal"</span>
    private_ip                   <span class="o">=</span> <span class="s2">"172.31.7.180"</span>
    public_dns                   <span class="o">=</span> <span class="s2">"ec2-52-40-175-176.us-west-2.compute.amazonaws.com"</span>
    public_ip                    <span class="o">=</span> <span class="s2">"52.40.175.176"</span>
    security_groups              <span class="o">=</span> <span class="o">[</span>
        <span class="s2">"default"</span>,
    <span class="o">]</span>
    source_dest_check            <span class="o">=</span> <span class="nb">true
    </span>subnet_id                    <span class="o">=</span> <span class="s2">"subnet-31855d6c"</span>
    tenancy                      <span class="o">=</span> <span class="s2">"default"</span>
    volume_tags                  <span class="o">=</span> <span class="o">{}</span>
    vpc_security_group_ids       <span class="o">=</span> <span class="o">[</span>
        <span class="s2">"sg-0edc8a5a"</span>,
    <span class="o">]</span>

    credit_specification <span class="o">{</span>
        cpu_credits <span class="o">=</span> <span class="s2">"standard"</span>
    <span class="o">}</span>

    metadata_options <span class="o">{</span>
        http_endpoint               <span class="o">=</span> <span class="s2">"enabled"</span>
        http_put_response_hop_limit <span class="o">=</span> 1
        http_tokens                 <span class="o">=</span> <span class="s2">"optional"</span>
    <span class="o">}</span>

    root_block_device <span class="o">{</span>
        delete_on_termination <span class="o">=</span> <span class="nb">true
        </span>device_name           <span class="o">=</span> <span class="s2">"/dev/sda1"</span>
        encrypted             <span class="o">=</span> <span class="nb">false
        </span>iops                  <span class="o">=</span> 0
        volume_id             <span class="o">=</span> <span class="s2">"vol-0ae0e70f9b4874d59"</span>
        volume_size           <span class="o">=</span> 8
        volume_type           <span class="o">=</span> <span class="s2">"standard"</span>
    <span class="o">}</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando <em>Terraform</em> creó esta instancia de <em>EC2</em>, también obtuvo mucha información sobre la misma. Estos valores pueden ser referenciados para configurar otros recursos o salidas, esto lo discutiremos más adelante.</p>
</div>
<div class="sect4">
<h5 id="_manejando_el_estado_manualmente">Manejando el estado manualmente</h5>
<div class="paragraph">
<p><em>Terraform</em> tiene un comando llamado <code>terraform state</code> para el manejo avanzado del estado. Por ejemplo, si tenemos un archivo de estado muy grande, podemos listar los recursos que están en el estado, los cuales podemos obtenerlos al ejecutar el subcomando <code>list</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>terraform state list
aws_instance.ejemplo</code></pre>
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_cambios_a_la_infraestructura">Cambios a la Infraestructura</h3>
<div class="paragraph">
<p>Previamente, creamos nuestra primera infraestructura con <em>Terraform</em>: una instancia simple de <em>EC2</em>. En esta sección, haremos modificaciones a este recurso y veremos como <em>Terraform</em> maneja estos cambios.</p>
</div>
<div class="paragraph">
<p>La infraestructura está en constante evolución, y <em>Terraform</em> fue hecho para ayudar a manejar y hacer estos cambios. Cuando escribimos cambios en las configuraciones de <em>Terraform</em>, este creará un plan de ejecución que solo modifica lo que sea necesario para alcanzar el estado deseado.</p>
</div>
<div class="paragraph">
<p>Al usar <em>Terraform</em> para hacer cambios en la infraestructura, podemos controlar no solo las versiones de la configuración, sino tambien el estado, de tal manera que podamos ver cómo la infraestructura evoluciona durante el tiempo.</p>
</div>
<div class="sect3">
<h4 id="_pre_requisitos_2">Pre requisitos</h4>
<div class="paragraph">
<p>Esta sección asume que se realizaron los pasos previos en esta misma obra, si no, debemos crear un directorio llamado <code>iac-libro-aws-instancia</code> y pegamos el siguiente código en un archivo llamado <code>ejemplo.tf</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">terraform <span class="o">{</span>
  required_providers <span class="o">{</span>
    aws <span class="o">=</span> <span class="o">{</span>
      <span class="nb">source</span>  <span class="o">=</span> <span class="s2">"hashicorp/aws"</span>
      version <span class="o">=</span> <span class="s2">"~&gt; 2.70"</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>

provider <span class="s2">"aws"</span> <span class="o">{</span>
  profile <span class="o">=</span> <span class="s2">"default"</span>
  region  <span class="o">=</span> <span class="s2">"us-west-2"</span>
<span class="o">}</span>

resource <span class="s2">"aws_instance"</span> <span class="s2">"ejemplo"</span> <span class="o">{</span>
  ami           <span class="o">=</span> <span class="s2">"ami-830c94e3"</span>
  instance_type <span class="o">=</span> <span class="s2">"t2.micro"</span>
<span class="o">}</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_configuración">Configuración</h4>
<div class="paragraph">
<p>Ahora actualizaremos el <code>ami</code> de nuestra instancia. Cambiemos el recurso <code>aws_instance.ejemplo</code> debajo del bloque de proveedor en <code>ejemplo.tf</code> reemplazando el identificador del <em>AMI</em> por uno nuevo.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>El siguiente código, está en formato <em>diff</em> para darnos en contexto qué debemos cambiar en la configuración</p>
</div>
</td>
</tr>
</table>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">resource <span class="s2">"aws_instance"</span> <span class="s2">"ejemplo"</span> <span class="o">{</span>
- ami           <span class="o">=</span> <span class="s2">"ami-830c94e3"</span>
+ ami           <span class="o">=</span> <span class="s2">"ami-08d70e59c07c61a3a"</span>
  instance_type <span class="o">=</span> <span class="s2">"t2.micro"</span>
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Esto hará el cambio del <em>AMI</em> a Ubuntu 16.04. Las configuraciones de <em>Terraform</em> están diseñadas para modificarse directamente y sabrá qué tendrá que destruir la antigua instancia y crear una nueva.</p>
</div>
</div>
<div class="sect3">
<h4 id="_aplicación_de_los_cambios">Aplicación de los cambios.</h4>
<div class="paragraph">
<p>Después de cambiar la configuración, corremos <code>terraform apply</code> de nuevo para ver cómo <em>Terraform</em> aplicará los cambios a los recursos existentes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>terraform apply
aws_instance.ejemplo: Refreshing state... <span class="o">[</span><span class="nb">id</span><span class="o">=</span>i-0f57d1b36088f27ae]

An execution plan has been generated and is shown below.
Resource actions are indicated with the following symbols:
-/+ destroy and <span class="k">then </span>create replacement

Terraform will perform the following actions:

  <span class="c"># aws_instance.ejemplo must be replaced</span>
-/+ resource <span class="s2">"aws_instance"</span> <span class="s2">"ejemplo"</span> <span class="o">{</span>
      ~ ami                          <span class="o">=</span> <span class="s2">"ami-830c94e3"</span> -&gt; <span class="s2">"ami-08d70e59c07c61a3a"</span> <span class="c"># forces replacement</span>
      ~ arn                          <span class="o">=</span> <span class="s2">"arn:aws:ec2:us-west-2:561656980159:instance/i-0f57d1b36088f27ae"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ associate_public_ip_address  <span class="o">=</span> <span class="nb">true</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ availability_zone            <span class="o">=</span> <span class="s2">"us-west-2c"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ cpu_core_count               <span class="o">=</span> 1 -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ cpu_threads_per_core         <span class="o">=</span> 1 -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      - disable_api_termination      <span class="o">=</span> <span class="nb">false</span> -&gt; null
      - ebs_optimized                <span class="o">=</span> <span class="nb">false</span> -&gt; null
      - hibernation                  <span class="o">=</span> <span class="nb">false</span> -&gt; null
      + host_id                      <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      ~ <span class="nb">id</span>                           <span class="o">=</span> <span class="s2">"i-0f57d1b36088f27ae"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ instance_state               <span class="o">=</span> <span class="s2">"running"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ ipv6_address_count           <span class="o">=</span> 0 -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ ipv6_addresses               <span class="o">=</span> <span class="o">[]</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      + key_name                     <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      - monitoring                   <span class="o">=</span> <span class="nb">false</span> -&gt; null
      + network_interface_id         <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + outpost_arn                  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + password_data                <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      + placement_group              <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
      ~ primary_network_interface_id <span class="o">=</span> <span class="s2">"eni-0b899ad3349b26177"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ private_dns                  <span class="o">=</span> <span class="s2">"ip-172-31-7-180.us-west-2.compute.internal"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ private_ip                   <span class="o">=</span> <span class="s2">"172.31.7.180"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ public_dns                   <span class="o">=</span> <span class="s2">"ec2-52-40-175-176.us-west-2.compute.amazonaws.com"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ public_ip                    <span class="o">=</span> <span class="s2">"52.40.175.176"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ security_groups              <span class="o">=</span> <span class="o">[</span>
          - <span class="s2">"default"</span>,
        <span class="o">]</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ subnet_id                    <span class="o">=</span> <span class="s2">"subnet-31855d6c"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      - tags                         <span class="o">=</span> <span class="o">{}</span> -&gt; null
      ~ tenancy                      <span class="o">=</span> <span class="s2">"default"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ volume_tags                  <span class="o">=</span> <span class="o">{}</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
      ~ vpc_security_group_ids       <span class="o">=</span> <span class="o">[</span>
          - <span class="s2">"sg-0edc8a5a"</span>,
        <span class="o">]</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
        <span class="c"># (3 unchanged attributes hidden)</span>

      - credit_specification <span class="o">{</span>
          - cpu_credits <span class="o">=</span> <span class="s2">"standard"</span> -&gt; null
        <span class="o">}</span>

      + ebs_block_device <span class="o">{</span>
          + delete_on_termination <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + device_name           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + encrypted             <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + iops                  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + kms_key_id            <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + snapshot_id           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + volume_id             <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + volume_size           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + volume_type           <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
        <span class="o">}</span>

      + ephemeral_block_device <span class="o">{</span>
          + device_name  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + no_device    <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + virtual_name <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
        <span class="o">}</span>

      ~ metadata_options <span class="o">{</span>
          ~ http_endpoint               <span class="o">=</span> <span class="s2">"enabled"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
          ~ http_put_response_hop_limit <span class="o">=</span> 1 -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
          ~ http_tokens                 <span class="o">=</span> <span class="s2">"optional"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
        <span class="o">}</span>

      + network_interface <span class="o">{</span>
          + delete_on_termination <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + device_index          <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          + network_interface_id  <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
        <span class="o">}</span>

      ~ root_block_device <span class="o">{</span>
          ~ delete_on_termination <span class="o">=</span> <span class="nb">true</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
          ~ device_name           <span class="o">=</span> <span class="s2">"/dev/sda1"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
          ~ encrypted             <span class="o">=</span> <span class="nb">false</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
          ~ iops                  <span class="o">=</span> 0 -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
          + kms_key_id            <span class="o">=</span> <span class="o">(</span>known after apply<span class="o">)</span>
          ~ volume_id             <span class="o">=</span> <span class="s2">"vol-0ae0e70f9b4874d59"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
          ~ volume_size           <span class="o">=</span> 8 -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
          ~ volume_type           <span class="o">=</span> <span class="s2">"standard"</span> -&gt; <span class="o">(</span>known after apply<span class="o">)</span>
        <span class="o">}</span>
    <span class="o">}</span>

Plan: 1 to add, 0 to change, 1 to destroy.

Do you want to perform these actions?
  Terraform will perform the actions described above.
  Only <span class="s1">'yes'</span> will be accepted to approve.

  Enter a value:</code></pre>
</div>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_capítulo_4_introducción_a_packer">Capítulo 4. Introducción a Packer</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Packer es una herramienta de creación de imágenes de código abierto, escrita en Go. Packer también forma parte del stack de <strong><em>Hashicorp</em></strong>. Este nos permite crear imágenes de máquinas idénticas, para múltiples plataformas de destino desde una única fuente de configuración, lo que facilita la gestión de la configuración y el aprovisionamiento de la infraestructura. Packer es relativamente rápido de aprender y fácil de automatizar. Cuando se usa en combinación con herramientas de administración de configuración, se pueden crear imágenes complejas y totalmente funcionales con software preinstalado y preconfigurado.</p>
</div>
<div class="paragraph">
<p>Una imagen de máquina es una unidad estática que contiene un sistema operativo preconfigurado y un software instalado. Podemos usar imágenes para clonar o crear nuevos hosts. Las imágenes ayudan a acelerar el proceso de construcción y despliegue de nueva infraestructura. Estas existen en muchos formatos, específicos para diversas plataformas y entornos de implementación.</p>
</div>
<div class="paragraph">
<p>Packer es compatible con Linux, Windows y Mac OS X. También es compatible con una amplia variedad de formatos de imagen cmo Amazon EC2, CloudStack, DigitalOcean, Docker, Google Compute Engine, Microsoft Azure, QEMU, VirtualBox, VMware y más. También cuenta con integraciones para otras herramientas, como <strong><em>Ansible</em></strong> y <strong><em>Vagrant</em></strong>.</p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Esta introducción está basada en la documentación oficial de Hashicorp <a href="#intro_packer">[intro_packer]</a>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Código Ejemplo de plantilla de Packer para crear una imagen para AWS</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
    </span><span class="nl">"variables"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
        </span><span class="nl">"aws_access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{env `AWS_ACCESS_KEY_ID`}}"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"aws_secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{env `AWS_SECRET_ACCESS_KEY`}}"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"region"</span><span class="p">:</span><span class="w">         </span><span class="s2">"us-east-1"</span><span class="w">
    </span><span class="p">},</span><span class="w">
    </span><span class="nl">"builders"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
        </span><span class="nl">"access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_access_key`}}"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"ami_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"packer-aws-image-{{timestamp}}"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"instance_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t3.micro"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ap-south-1"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_secret_key`}}"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"source_ami_filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
            </span><span class="nl">"virtualization-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hvm"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu/images/*ubuntu-xenial-20.04-amd64-server-*"</span><span class="p">,</span><span class="w">
            </span><span class="nl">"root-device-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ebs"</span><span class="w">
         </span><span class="p">},</span><span class="w">
         </span><span class="nl">"owners"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="s2">"1239720102247"</span><span class="p">],</span><span class="w">
         </span><span class="nl">"most_recent"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
        </span><span class="p">},</span><span class="w">
        </span><span class="nl">"ssh_username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amazon-ebs"</span><span class="w">
    </span><span class="p">}</span><span class="w">
    </span><span class="p">],</span><span class="w">
    </span><span class="nl">"provisioners"</span><span class="p">:</span><span class="w"> </span><span class="p">[{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../scripts/setup.sh"</span><span class="w">
    </span><span class="p">}]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="sect2">
<h3 id="_características_2">Características</h3>
<div class="paragraph">
<p>Algunas de las características más importantes de <em>Packer</em> son:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Rápido despliegue de infraestructura:</strong> las imágenes de Packer permiten lanzar máquinas completamente configuradas y aprovisionadas en segundos. Esto beneficia también a los ambientes de desarrollo, ya que se pueden crear Boxes de Vagrant con Packer, aprovisionadas de la misma manera que en producción, lo que mantiene la paridad.</p>
</li>
<li>
<p><strong>Detección anticipada de problemas:</strong> Packer instala y configura el software de una máquina en el momento en que se crea la imagen. Si hay errores en este proceso, se detectarán a tiempo en las fases de construcción de un flujo o <em>pipeline</em> de CI/CD en lugar de descubrirlos cuando inicie el entorno.</p>
</li>
<li>
<p><strong>Basado en constructores para múltiples formatos de imagen:</strong> los constructores o <em>builders</em> leen la configuración y la usan para ejecutar y generar una imagen de máquina virtual. Son constructores: VirtualBox, VMware y Amazon EC2 y más. <sup class="footnote">[<a id="_footnoteref_8" class="footnote" href="#_footnotedef_8" title="View footnote.">8</a>]</sup>. Los constructores son el equivalente a los proveedores de Terraform.</p>
</li>
<li>
<p><strong>Portabilidad de entornos:</strong> ya que Packer puede crear imágenes idénticas para múltiples plataformas,es posible ejecutar el entorno de producción en AWS,el entorno de  QA en una nube privada como OpenStack y los entornos de desarrollo en Vagrant.</p>
</li>
<li>
<p><strong>Soporte para multiples aprovisionadores:</strong> los <em>provisioners</em>  son componentes de Packer que instalan y configuran software dentro de una máquina antes de que esta se convierta en una imagen estática. Su principal objetivo es asegurarse que la imagen contenga software útil. Los aprovisionadores de ejemplo incluyen scripts de shell, Ansible, etc. <sup class="footnote">[<a id="_footnoteref_9" class="footnote" href="#_footnotedef_9" title="View footnote.">9</a>]</sup></p>
</li>
</ul>
</div>
</div>
<div class="sect2">
<h3 id="_casos_de_uso_2">Casos de uso</h3>
<div class="paragraph">
<p>Construir imágenes es tedioso. Es normalmente un proceso manual y por lo tanto, es propenso a errores. Packer puede automatizar la creación de imágenes e integrarse bien con herramientas de gestión de configuraciones como Ansible. Packer permite crear pipelines para construir e implementar imágenes, lo que a su vez nos permite producir imágenes consistentes y repetibles.</p>
</div>
<div class="paragraph">
<p>Estos son casos de uso aplicados en la industria: <sup class="footnote">[<a id="_footnoteref_10" class="footnote" href="#_footnotedef_10" title="View footnote.">10</a>]</sup></p>
</div>
<div class="sect3">
<h4 id="_consistencia_ambiental">Consistencia ambiental</h4>
<div class="paragraph">
<p>¿Tienes una infraestructura compleja, con numerosos entornos que abarcan desarrollo, pruebas, <em>staging</em> y producción? Packer es ideal para estandarizar esos entornos. Como admite numerosas plataformas de destino, puede crear imágenes estándar para todo tipo de plataformas.</p>
</div>
<div class="paragraph">
<p>Por ejemplo, un equipo de seguridad puede usar Packer para crear imágenes que luego se comparten con otros grupos para proporcionar el “hardening” de base que para imponer estándares entre equipos.</p>
</div>
</div>
<div class="sect3">
<h4 id="_entrega_continua">Entrega continua</h4>
<div class="paragraph">
<p>Packer se integra bien con las herramientas de infraestructura existentes. Se puede agregar en un pipeline de implementación. Es decir, parte del pipeline será crear la imagen. Un ejemplo de esto es la fase <em>Bake</em> de <em>Spinnaker</em> <sup class="footnote">[<a id="_footnoteref_11" class="footnote" href="#_footnotedef_11" title="View footnote.">11</a>]</sup>.</p>
</div>
<div class="paragraph">
<p>Packer puede crear imágenes de Amazon Machine Images (AMI), después Terraform puede usar esas AMI cuando se crean hosts y servicios y podemos ejecutar Ansible ( periódicamente) para proporcionar la configuración final y mantener nuestros hosts configurados correctamente.</p>
</div>
<div class="paragraph">
<p>Esto significa que si necesitamos un nuevo host o tenemos que reemplazar un host que no funciona correctamente, el proceso es rápido y consistente. Nuestra infraestructura se vuelve desechable, reemplazable y repetible. Es decir, manejamos un enfoque de infraestructura inmutable.</p>
</div>
<div class="paragraph">
<p>Los beneficios de una infraestructura inmutable incluyen más consistencia y confiabilidad en la infraestructura y un proceso de implementación más simple y predecible. Mitiga o previene por completo los problemas que son comunes en las infraestructuras mutables, como las diferencias de configuración.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_instalación_de_packer">Instalación de <em>Packer</em></h3>
<div class="paragraph">
<p>Instalaremos el binario de Packer en nuestro equipo personal para ejecutar la construcción de imagenes en la nube de AWS. Packer se puede instalar de las siguientes formas:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Usando un binario precompilado.</p>
</li>
<li>
<p>Construyendo desde la fuente.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>La forma estandar es usar los binarios que Hashicorp lanza. Este método se recomienda para la mayoría de los usuarios.</p>
</div>
<div class="sect3">
<h4 id="_instalación_manual_2">Instalación Manual</h4>
<div class="paragraph">
<p>Para la instalación manual de <em>Packer</em>, necesitamos encontrar el paquete apropiado <sup class="footnote">[<a id="_footnoteref_12" class="footnote" href="#_footnotedef_12" title="View footnote.">12</a>]</sup> para nuestro sistema operativo y bajarlo, este será un archivo <em>zip</em>.</p>
</div>
<div class="paragraph">
<p>Una vez que se haya descargado, procederemos a descomprimir el archivo <em>zip</em>.</p>
</div>
<div class="paragraph">
<p>Finalmente, nos aseguraremos de que <code>packer</code> se encuentre disponible en nuestro <code>PATH</code>. Esto se realiza de manera diferente, dependiendo el sistema operativo.</p>
</div>
<div class="sect4">
<h5 id="_mac_o_linux_2">Mac o Linux</h5>
<div class="paragraph">
<p>Obtenemos la lista de rutas que están disponibles en la variable de entorno <code>PATH</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="nb">echo</span> $PATH</code></pre>
</div>
</div>
<div class="paragraph">
<p>Movemos el binario de <em>Packer</em> a uno de las rutas listadas. Este comando asume que el binario se encuentra en el archivo de descargas y que <code>PATH</code> contiene <code>/usr/local/bin</code>, personaliza en caso de las rutas en tu sistema operativo sean diferentes.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">mv</span> <span class="o">~</span><span class="na">/Downloads/packer /usr/local/bin</span>/</code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_windows_2">Windows</h4>
<div class="paragraph">
<p>En la siguiente dirección de internet, podemos encontrar las instrucciones exactas para modificar el <code>PATH</code> en <em>Windows</em> através de la interfaz gráfica: <code><a href="https://stackoverflow.com/questions/1618280/where-can-i-set-path-to-make-exe-on-windows" class="bare">https://stackoverflow.com/questions/1618280/where-can-i-set-path-to-make-exe-on-windows</a></code></p>
</div>
</div>
<div class="sect3">
<h4 id="_instalación_con_homebrew_en_macos_2">Instalación con <em>Homebrew</em> en <em>MacOS</em></h4>
<div class="paragraph">
<p><em>Homebrew</em> es un manejador de paquetes de fuente abierta para el sistema operativo <em>MacOS</em>. Instala la <em>formula</em> oficial de <em>Packer</em> desde la terminal.</p>
</div>
<div class="paragraph">
<p>Primero, installamos el <em>tap</em> de <em>HashiCorp</em>, un repositorio para todos los paquetes de <em>Homebrew</em> de la compañia:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">brew</span> <span class="kd">tap</span> <span class="kd">hashicorp</span><span class="na">/tap</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora, Instalamos <em>Packer</em> con <code>hashicorp/tap/packer</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">brew</span> <span class="kd">install</span> <span class="kd">hashicorp</span><span class="na">/tap/packer</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Para actualizar a la última versión, ejecutamos:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">brew</span> <span class="kd">upgrade</span> <span class="kd">hashicorp</span><span class="na">/tap/packer</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_instalación_con_chocolatey_en_windows_2">Instalación con <em>Chocolatey</em> en <em>Windows</em></h4>
<div class="paragraph">
<p><em>Chocolatey</em> es un manejador de paquetes de codigo abierto para <em>Windows</em>. Installamos el paquete de <em>Packer</em> desde la linea de comandos.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">choco</span> <span class="kd">install</span> <span class="kd">packer</span></code></pre>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_instalación_en_linux_2">Instalación en Linux</h4>
<div class="sect4">
<h5 id="_ubuntudebian_2">Ubuntu/Debian</h5>
<div class="paragraph">
<p>Agregamos la llave <em>GPG</em> de <em>HashiCorp</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="nb">curl</span> <span class="na">-fsSL </span><span class="kd">https</span>://apt.releases.hashicorp.com/gpg <span class="o">|</span> <span class="kd">sudo</span> <span class="kd">apt</span><span class="na">-key </span><span class="kd">add</span> <span class="o">-</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Agregamos los repositorios oficiales de <em>HashiCorp</em> para <em>Linux</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">apt</span><span class="na">-add-repository </span><span class="s2">"deb [arch=amd64] https://apt.releases.hashicorp.com $(lsb_release -cs) main"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Actualización e instalación.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">apt</span><span class="na">-get </span><span class="kd">update</span> <span class="o">&amp;&amp;</span> <span class="kd">sudo</span> <span class="kd">apt</span><span class="na">-get </span><span class="kd">install</span> <span class="kd">packer</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_centosrhel_2">CentOS/RHEL</h5>
<div class="paragraph">
<p>Instalamos <code>yum-config-manager</code> para manejar repositorios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">yum</span> <span class="kd">install</span> <span class="na">-y </span><span class="kd">yum</span><span class="na">-utils</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Usamos <code>yum-config-manager</code> para agregar el repositorio oficial de <em>HachiCorp</em> para <em>Linux</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">yum</span><span class="na">-config-manager --add-repo </span><span class="kd">https</span>://rpm.releases.hashicorp.com/RHEL/hashicorp.repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instalamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">yum</span> <span class="na">-y </span><span class="kd">install</span> <span class="kd">packer</span></code></pre>
</div>
</div>
</div>
<div class="sect4">
<h5 id="_fedora_2">Fedora</h5>
<div class="paragraph">
<p>Instalamos <code>dnf config-manager</code> para manejar repositorios.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">dnf</span> <span class="kd">install</span> <span class="na">-y </span><span class="kd">dnf</span><span class="na">-plugins-core</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Usamos <code>dnf config-manager</code> para agregar el repositorio oficial de <em>HachiCorp</em> para <em>Linux</em></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">dnf</span> <span class="kd">config</span><span class="na">-manager --add-repo </span><span class="kd">https</span>://rpm.releases.hashicorp.com/fedora/hashicorp.repo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Instalamos</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">sudo</span> <span class="kd">dnf</span> <span class="na">-y </span><span class="kd">install</span> <span class="kd">packer</span></code></pre>
</div>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_verificación_de_la_instalación_2">Verificación de la instalación.</h4>
<div class="paragraph">
<p>Para verificar la instalación abrimos una nueva terminal y ejecutamos <code>packer</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch">$ <span class="kd">packer</span> <span class="na">-help
</span><span class="kd">Usage</span>: <span class="kd">packer</span> <span class="o">[</span><span class="na">--version</span><span class="o">]</span> <span class="o">[</span><span class="na">--help</span><span class="o">]</span> <span class="o">&lt;</span><span class="kd">command</span><span class="o">&gt;</span> <span class="o">[&lt;</span><span class="kd">args</span><span class="o">&gt;]</span>

<span class="kd">Available</span> <span class="kd">commands</span> <span class="kd">are</span>:
    <span class="kd">build</span>           <span class="kd">build</span> <span class="kd">image</span><span class="o">(</span><span class="kd">s</span><span class="o">)</span> <span class="kd">from</span> <span class="kd">template</span>
    <span class="kd">console</span>         <span class="kd">creates</span> <span class="kd">a</span> <span class="kd">console</span> <span class="k">for</span> <span class="kd">testing</span> <span class="kd">variable</span> <span class="kd">interpolation</span>
    <span class="kd">fix</span>             <span class="kd">fixes</span> <span class="kd">templates</span> <span class="kd">from</span> <span class="kd">old</span> <span class="kd">versions</span> <span class="kd">of</span> <span class="kd">packer</span>
    <span class="kd">hcl2_upgrade</span>    <span class="kd">transform</span> <span class="kd">a</span> <span class="kd">JSON</span> <span class="kd">template</span> <span class="kd">into</span> <span class="kd">a</span> <span class="kd">HCL2</span> <span class="kd">configuration</span>
    <span class="kd">inspect</span>         <span class="kd">see</span> <span class="kd">components</span> <span class="kd">of</span> <span class="kd">a</span> <span class="kd">template</span>
    <span class="kd">validate</span>        <span class="kd">check</span> <span class="kd">that</span> <span class="kd">a</span> <span class="kd">template</span> <span class="kd">is</span> <span class="kd">valid</span>
    <span class="kd">version</span>         <span class="kd">Prints</span> <span class="kd">the</span> <span class="kd">Packer</span> <span class="kd">version</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cualquier sub comando despues de <code>packer -help</code> permite aprender más sobre el mismo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch"><span class="kd">packer</span> <span class="na">-help </span><span class="kd">build</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Con esto finalizamos la instalación de <em>Packer</em> y estamos listos para empezar a construir imagenes en la nube.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_construcción_de_imágenes">Construcción de imágenes</h3>
<div class="paragraph">
<p>Con <em>Packer</em> instalado, estamos listos para crear nuestra primer imagen.</p>
</div>
<div class="paragraph">
<p>Packer usa una plantilla en formato JSON para definir una imagen. Hay tres secciones principales en el archivo: constructores, aprovisionadores y postprocesamiento.</p>
</div>
<div class="paragraph">
<p><strong>Los constructores</strong> son los que determinan qué tipo de imagen vamos crear. Aquí es donde le decimos a Packer que queremos una imagen para AWS en formato AMI o una para Virtualbox en formato OVF.</p>
</div>
<div class="paragraph">
<p>No estamos limitados a un solo constructor. Si necesitamos una imagen idéntica para usarla en AWS y Vagrant, definimos varios constructores.</p>
</div>
<div class="paragraph">
<p><strong>Los aprovisionadores</strong> son la siguiente sección de un archivo JSON de Packer. Una vez instalado el sistema operativo, se invoca a los aprovisionadores para configurar el sistema.</p>
</div>
<div class="paragraph">
<p>Hay una gran cantidad de opciones disponibles, desde scripts de shell básicos hasta el uso de playbooks de Ansible.Lo importante para mantener un enfoque DevOps es usar los mismos scripts que usamos en un servidor de producción pero aplicados a un entorno de desarrollo local con Vagrant. De esta manera el entorno de Desarrollo y Producción mantendrán paridad.</p>
</div>
<div class="paragraph">
<p>Por último, están <strong>los postprocesadores</strong>. Estos son opcionales. Por ejemplo, son necesarios para crear Boxes de Vagrant. Estas se generan tomando una imagen genérica en OVF para Virtualbox y empaquetándola como una imagen de Vagrant. Otras opciones comúnmente usadas en los postprocesadores son la compresión de la imagen.</p>
</div>
<div class="sect3">
<h4 id="_pre_requisitos_3">Pre requisitos</h4>
<div class="paragraph">
<p>Para continuar, necesitamos:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Una cuenta de <em>AWS</em>.</p>
</li>
<li>
<p>La intefaz de línea de comando de <em>AWS</em>.</p>
</li>
<li>
<p>Las credenciales de <em>AWS</em> configuradas localmente.</p>
</li>
<li>
<p>Crear una llave SSH</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Esto está descrito en el Apéndice <a href="#">Creación y configuración de una cuenta de Amazon Web Services</a></p>
</div>
<div class="sect4">
<h5 id="_crear_llave_ssh">Crear llave SSH</h5>
<div class="paragraph">
<p>Crearemos una llave  SSH local para conectarnos con el usuario terraform que crearemos en la instancia.</p>
</div>
<div class="paragraph">
<p>Genera una nueva clave SSH llamada <code>tf-packer</code>. El argumento proporcionado con la bandera <code>-f</code> crea la clave en el directorio actual y crea dos archivos llamados <code>tf-packer</code> y <code>tf-packer.pub</code>. Cambie la dirección de correo electrónico.</p>
</div>
</div>
<div class="sect4">
<h5 id="_línea_de_comandos_de_mac_o_linux">Línea de comandos de Mac o Linux</h5>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="batch">$ <span class="kd">ssh</span><span class="na">-keygen -t </span><span class="kd">rsa</span> <span class="na">-C </span><span class="s2">"correo@ejemplo.com"</span> <span class="na">-f </span>./tf<span class="na">-packer</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Cuando se  solicite, presiona Intro para dejar la contraseña en blanco.</p>
</div>
</div>
<div class="sect4">
<h5 id="_windows_con_putty">Windows con PuTTY</h5>
<div class="paragraph">
<p>Si estás en una máquina con Windows, usa Putty para generar claves SSH siguiendo las instrucciones del siguiente enlace: <a href="https://www.ssh.com/ssh/putty/windows/puttygen/" class="bare">https://www.ssh.com/ssh/putty/windows/puttygen/</a>.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_escribir_plantillas_de_packer">Escribir plantillas de Packer</h4>
<div class="paragraph">
<p>A continuación crearemos una imagen con Packer en AWS y aprovisionaremos software en ella. Posteriormente usaremos esta imagen con Terraform para crear infraestructura.</p>
</div>
<div class="paragraph">
<p>Creamos un directorio llamado  <code>iac-libro-packer</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>iac-libro-packer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos cambiamos al directorio recién creado</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>iac-libro-packer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Dentro, creamos el directorio <code>imagenes</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>imagenes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos cambiamos al directorio recién creado</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>imagenes</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creamos la plantilla <code>imagen.json</code> de Packer con la siguiente estructura.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"variables"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"aws_access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{env `AWS_ACCESS_KEY`}}"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"aws_secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{env `AWS_SECRET_KEY`}}"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"aws_region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="w">
  </span><span class="p">},</span><span class="w">
  </span><span class="nl">"builders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amazon-ebs"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_access_key`}}"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_secret_key`}}"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_region`}}"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"source_ami_filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"virtualization-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hvm"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu/images/*ubuntu-xenial-16.04-amd64-server-*"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"root-device-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ebs"</span><span class="w">
              </span><span class="p">},</span><span class="w">
              </span><span class="nl">"owners"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                  </span><span class="s2">"099720109477"</span><span class="w">
              </span><span class="p">],</span><span class="w">
              </span><span class="nl">"most_recent"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"instance_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t2.micro"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"ssh_username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"ami_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"learn-packer {{timestamp}}"</span><span class="w">
      </span><span class="p">}</span><span class="w">
  </span><span class="p">],</span><span class="w">
  </span><span class="nl">"provisioners"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../tf-packer.pub"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/tf-packer.pub"</span><span class="w">
      </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../scripts/setup.sh"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El bloque de <strong>variables</strong>  determina las variables de entorno que Packer utilizará para la cuenta de AWS. Esta región debe coincidir con la región donde Terraform implementará la infraestructura, por lo que si la personalizas, tendrás que  personalizar la configuración de Terraform para que coincida (más adelante).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="p">{</span><span class="w">
  </span><span class="nl">"variables"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
      </span><span class="nl">"aws_access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{env `AWS_ACCESS_KEY`}}"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"aws_secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{env `AWS_SECRET_KEY`}}"</span><span class="p">,</span><span class="w">
      </span><span class="nl">"aws_region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"us-east-1"</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>El bloque de <strong>constructores</strong> crea una imagen en formato AMI denominada imagen-iac-libro-{{timestamp}} que se basa en una imagen t2.micro de Ubuntu con Elastic Block Storage (EBS).</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="nl">"builders"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
      </span><span class="p">{</span><span class="w">
          </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"amazon-ebs"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"access_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_access_key`}}"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"secret_key"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_secret_key`}}"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"region"</span><span class="p">:</span><span class="w"> </span><span class="s2">"{{user `aws_region`}}"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"source_ami_filter"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
              </span><span class="nl">"filters"</span><span class="p">:</span><span class="w"> </span><span class="p">{</span><span class="w">
                  </span><span class="nl">"virtualization-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"hvm"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu/images/*ubuntu-xenial-16.04-amd64-server-*"</span><span class="p">,</span><span class="w">
                  </span><span class="nl">"root-device-type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ebs"</span><span class="w">
              </span><span class="p">},</span><span class="w">
              </span><span class="nl">"owners"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
                  </span><span class="s2">"099720109477"</span><span class="w">
              </span><span class="p">],</span><span class="w">
              </span><span class="nl">"most_recent"</span><span class="p">:</span><span class="w"> </span><span class="kc">true</span><span class="w">
          </span><span class="p">},</span><span class="w">
          </span><span class="nl">"instance_type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"t2.micro"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"ssh_username"</span><span class="p">:</span><span class="w"> </span><span class="s2">"ubuntu"</span><span class="p">,</span><span class="w">
          </span><span class="nl">"ami_name"</span><span class="p">:</span><span class="w"> </span><span class="s2">"learn-packer {{timestamp}}"</span><span class="w">
      </span><span class="p">}</span><span class="w">
</span><span class="p">]</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Finalmente, el bloque de <strong>aprovisionadores</strong> aprovisiona las instancias con scripts o archivos específicos.</p>
</div>
<div class="paragraph">
<p>El primer aprovisionador es un aprovisionador de tipo de archivo y copia la clave SSH pública recién creada en un directorio temporal de la imagen.</p>
</div>
<div class="paragraph">
<p>El segundo aprovisionador es uden tipo shell que apunta a la ruta relativa a un script de bash. Packer utiliza estos aprovisionadores para personalizar la imagen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="json"><span class="nl">"provisioners"</span><span class="p">:</span><span class="w"> </span><span class="p">[</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"file"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"source"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../tf-packer.pub"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"destination"</span><span class="p">:</span><span class="w"> </span><span class="s2">"/tmp/tf-packer.pub"</span><span class="w">
      </span><span class="p">},</span><span class="w">
    </span><span class="p">{</span><span class="w">
        </span><span class="nl">"type"</span><span class="p">:</span><span class="w"> </span><span class="s2">"shell"</span><span class="p">,</span><span class="w">
        </span><span class="nl">"script"</span><span class="p">:</span><span class="w"> </span><span class="s2">"../scripts/setup.sh"</span><span class="w">
    </span><span class="p">}</span><span class="w">
</span><span class="p">]</span><span class="w">
</span><span class="p">}</span></code></pre>
</div>
</div>
<div class="sect4">
<h5 id="_script_de_aprovisionamiento">Script de aprovisionamiento</h5>
<div class="paragraph">
<p>En la raíz del directorio <code>iac-libro-packer</code>, creamos el directorio <code>scripts</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>scripts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos cambiamos al directorio recién creado</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>scripts</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creamos el script <code>setup.sh</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="c">#!/bin/bash</span>
<span class="nb">set</span> <span class="nt">-e</span>

<span class="c"># Instalar dependencias</span>
<span class="nb">sudo </span><span class="nv">DEBIAN_FRONTEND</span><span class="o">=</span>noninteractive apt-get <span class="nt">-y</span> <span class="nt">-o</span> Dpkg::Options::<span class="o">=</span><span class="s2">"--force-confdef"</span> <span class="nt">-o</span> Dpkg::Options::<span class="o">=</span><span class="s2">"--force-confold"</span> dist-upgrade
<span class="nb">sudo </span>apt-get <span class="nt">-y</span> <span class="nt">-qq</span> <span class="nb">install </span>curl wget git vim apt-transport-https ca-certificates
<span class="nb">sudo </span>add-apt-repository ppa:longsleep/golang-backports <span class="nt">-y</span>
<span class="nb">sudo </span>apt <span class="nt">-y</span> <span class="nt">-qq</span> <span class="nb">install </span>golang-go

<span class="c"># Configurar no-password sudo para el grupo "hashicorp" y agregando el usuario "terraform"</span>
<span class="nb">sudo </span>groupadd <span class="nt">-r</span> hashicorp
<span class="nb">sudo </span>useradd <span class="nt">-m</span> <span class="nt">-s</span> /bin/bash terraform
<span class="nb">sudo </span>usermod <span class="nt">-a</span> <span class="nt">-G</span> hashicorp terraform
<span class="nb">sudo cp</span> /etc/sudoers /etc/sudoers.orig
<span class="nb">echo</span> <span class="s2">"terraform  ALL=(ALL) NOPASSWD:ALL"</span> | <span class="nb">sudo tee</span> /etc/sudoers.d/terraform

<span class="c"># Instalar la llave SSH</span>
<span class="nb">sudo mkdir</span> <span class="nt">-p</span> /home/terraform/.ssh
<span class="nb">sudo chmod </span>700 /home/terraform/.ssh
<span class="nb">sudo cp</span> /tmp/tf-packer.pub /home/terraform/.ssh/authorized_keys
<span class="nb">sudo chmod </span>600 /home/terraform/.ssh/authorized_keys
<span class="nb">sudo chown</span> <span class="nt">-R</span> terraform /home/terraform/.ssh
<span class="nb">sudo </span>usermod <span class="nt">--shell</span> /bin/bash terraform

<span class="c"># Crear el path GOPATH para el usuario de  Terraform y descargar la aplicación web desde github</span>

<span class="nb">sudo</span> <span class="nt">-H</span> <span class="nt">-i</span> <span class="nt">-u</span> terraform <span class="nt">--</span> <span class="nb">env </span>bash <span class="o">&lt;&lt;</span> <span class="no">EOF</span><span class="sh">
whoami
echo ~terraform

cd /home/terraform

export GOROOT=/usr/lib/go
export GOPATH=/home/terraform/go
export PATH=</span><span class="nv">$PATH</span><span class="sh">:</span><span class="nv">$GOROOT</span><span class="sh">/bin:</span><span class="nv">$GOPATH</span><span class="sh">/bin
go get -d github.com/hashicorp/learn-go-webapp-demo
EOF</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Este script instala las dependencias necesarias, agrega el usuario terraform al grupo sudo, instala la clave SSH creada anteriormente y descarga una aplicación web  en GoLang de muestra.</p>
</div>
</div>
</div>
<div class="sect3">
<h4 id="_construir_la_imagen">Construir la imagen</h4>
<div class="paragraph">
<p>Ejecuta el comando de construcción de Packer pasando como argumentola plantilla de imagen.</p>
</div>
<div class="paragraph">
<p>Nos cambiamos al directorio <code>imagenes</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>images</code></pre>
</div>
</div>
<div class="paragraph">
<p>Construimos la imagen</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>packer build image.json</code></pre>
</div>
</div>
<div class="paragraph">
<p>Debes ver una salida similar a esta</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="o">==&gt;</span> amazon-ebs: Prevalidating any provided VPC information
<span class="o">==&gt;</span> amazon-ebs: Prevalidating AMI Name: learn-packer 1594419525
    amazon-ebs: Found Image ID: ami-0fcf65d66fe3e1f92
<span class="o">==&gt;</span> amazon-ebs: Creating temporary keypair: packer_5f08e945-d87e-c0e0-9c06-127cb40d51f4
<span class="o">==&gt;</span> amazon-ebs: Creating temporary security group <span class="k">for </span>this instance: packer_5f08e947-d29d-8982-903a-f1532932d397
<span class="o">==&gt;</span> amazon-ebs: Authorizing access to port 22 from <span class="o">[</span>0.0.0.0/0] <span class="k">in </span>the temporary security groups...
<span class="o">==&gt;</span> amazon-ebs: Launching a <span class="nb">source </span>AWS instance...
<span class="o">==&gt;</span> amazon-ebs: Adding tags to <span class="nb">source </span>instance
    amazon-ebs: Adding tag: <span class="s2">"Name"</span>: <span class="s2">"Packer Builder"</span>
    amazon-ebs: Instance ID: i-0208315d85b166c4b
<span class="o">==&gt;</span> amazon-ebs: Waiting <span class="k">for </span>instance <span class="o">(</span>i-0208315d85b166c4b<span class="o">)</span> to become ready...
<span class="o">==&gt;</span> amazon-ebs: Using ssh communicator to connect: 54.81.101.149
<span class="o">==&gt;</span> amazon-ebs: Waiting <span class="k">for </span>SSH to become available...
<span class="o">==&gt;</span> amazon-ebs: Connected to SSH!
<span class="o">==&gt;</span> amazon-ebs: Uploading ../tf-packer.pub <span class="o">=&gt;</span> /tmp/tf-packer.pub
newkey.pub 574 B / 574 B <span class="o">[===============================================]</span> 100.00% 0s
<span class="o">==&gt;</span> amazon-ebs: Provisioning with shell script: ../scripts/setup.sh
    amazon-ebs: Reading package lists...
    amazon-ebs: Building dependency tree...
    amazon-ebs: Reading state information...
<span class="o">==&gt;</span> amazon-ebs: Stopping the <span class="nb">source </span>instance...
    amazon-ebs: Stopping instance
<span class="o">==&gt;</span> amazon-ebs: Waiting <span class="k">for </span>the instance to stop...
<span class="o">==&gt;</span> amazon-ebs: Creating AMI learn-packer 1594419525 from instance i-0208315d85b166c4b
    amazon-ebs: AMI: ami-06cb92a18a30fec16
<span class="o">==&gt;</span> amazon-ebs: Waiting <span class="k">for </span>AMI to become ready...
<span class="o">==&gt;</span> amazon-ebs: Terminating the <span class="nb">source </span>AWS instance...
<span class="o">==&gt;</span> amazon-ebs: Cleaning up any extra volumes...
<span class="o">==&gt;</span> amazon-ebs: No volumes to clean up, skipping
<span class="o">==&gt;</span> amazon-ebs: Deleting temporary security group...
<span class="o">==&gt;</span> amazon-ebs: Deleting temporary keypair...
Build <span class="s1">'amazon-ebs'</span> finished.

<span class="o">==&gt;</span> Builds finished. The artifacts of successful builds are:
<span class="nt">--</span><span class="o">&gt;</span> amazon-ebs: AMIs were created:
us-east-1: ami-06cb92a18a30fec16</code></pre>
</div>
</div>
<div class="paragraph">
<p>La última línea de la salida es la ID de AMI que debemos pasar a la configuración de Terraform en el siguiente paso.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_desplegar_imagenes_de_packer_con_terraform">Desplegar imagenes de Packer con Terraform</h3>
<div class="paragraph">
<p>La AMI es el artefacto resultant de la ejecución de Packer y está disponible en la cuenta de AWS en la sección Imágenes de EC2. Puedes visitar la consola web de AWS para ver este ID de AMI nuevamente.</p>
</div>
<div class="paragraph">
<p>Para utilizar esta AMI en el entorno de Terraform, creamos un diretorio llamado <code>instancias</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">mkdir </span>instancias</code></pre>
</div>
</div>
<div class="paragraph">
<p>Nos cambiamos al directorio recién creado</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>instancias</code></pre>
</div>
</div>
<div class="paragraph">
<p>Creamos una plantilla de terraform `main.tf `</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">provider <span class="s2">"aws"</span> <span class="o">{</span>
  region <span class="o">=</span> var.region
<span class="o">}</span>

resource <span class="s2">"aws_vpc"</span> <span class="s2">"vpc"</span> <span class="o">{</span>
  cidr_block           <span class="o">=</span> var.cidr_vpc
  enable_dns_support   <span class="o">=</span> <span class="nb">true
  </span>enable_dns_hostnames <span class="o">=</span> <span class="nb">true</span>
<span class="o">}</span>

resource <span class="s2">"aws_internet_gateway"</span> <span class="s2">"igw"</span> <span class="o">{</span>
  vpc_id <span class="o">=</span> aws_vpc.vpc.id
<span class="o">}</span>

resource <span class="s2">"aws_subnet"</span> <span class="s2">"subnet_public"</span> <span class="o">{</span>
  vpc_id                  <span class="o">=</span> aws_vpc.vpc.id
  cidr_block              <span class="o">=</span> var.cidr_subnet
<span class="o">}</span>

resource <span class="s2">"aws_route_table"</span> <span class="s2">"rtb_public"</span> <span class="o">{</span>
  vpc_id <span class="o">=</span> aws_vpc.vpc.id

  route <span class="o">{</span>
    cidr_block <span class="o">=</span> <span class="s2">"0.0.0.0/0"</span>
    gateway_id <span class="o">=</span> aws_internet_gateway.igw.id
  <span class="o">}</span>
<span class="o">}</span>

resource <span class="s2">"aws_route_table_association"</span> <span class="s2">"rta_subnet_public"</span> <span class="o">{</span>
  subnet_id      <span class="o">=</span> aws_subnet.subnet_public.id
  route_table_id <span class="o">=</span> aws_route_table.rtb_public.id
<span class="o">}</span>

resource <span class="s2">"aws_security_group"</span> <span class="s2">"sg_22_80"</span> <span class="o">{</span>
  name   <span class="o">=</span> <span class="s2">"sg_22"</span>
  vpc_id <span class="o">=</span> aws_vpc.vpc.id

  <span class="c"># SSH access from the VPC</span>
  ingress <span class="o">{</span>
    from_port   <span class="o">=</span> 22
    to_port     <span class="o">=</span> 22
    protocol    <span class="o">=</span> <span class="s2">"tcp"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>

  ingress <span class="o">{</span>
    from_port   <span class="o">=</span> 8080
    to_port     <span class="o">=</span> 8080
    protocol    <span class="o">=</span> <span class="s2">"tcp"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>

    ingress <span class="o">{</span>
    from_port   <span class="o">=</span> 80
    to_port     <span class="o">=</span> 80
    protocol    <span class="o">=</span> <span class="s2">"tcp"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>

  egress <span class="o">{</span>
    from_port   <span class="o">=</span> 0
    to_port     <span class="o">=</span> 0
    protocol    <span class="o">=</span> <span class="s2">"-1"</span>
    cidr_blocks <span class="o">=</span> <span class="o">[</span><span class="s2">"0.0.0.0/0"</span><span class="o">]</span>
  <span class="o">}</span>
<span class="o">}</span>

resource <span class="s2">"aws_instance"</span> <span class="s2">"web"</span> <span class="o">{</span>
  ami                         <span class="o">=</span> <span class="s2">"ami-YOUR-AMI-ID"</span>
  instance_type               <span class="o">=</span> <span class="s2">"t2.micro"</span>
  subnet_id                   <span class="o">=</span> aws_subnet.subnet_public.id
  vpc_security_group_ids      <span class="o">=</span> <span class="o">[</span>aws_security_group.sg_22_80.id]
  associate_public_ip_address <span class="o">=</span> <span class="nb">true

  </span>tags <span class="o">=</span> <span class="o">{</span>
    Name <span class="o">=</span> <span class="s2">"Learn-Packer"</span>
  <span class="o">}</span>
<span class="o">}</span>

output <span class="s2">"id"</span> <span class="o">{</span>
  value <span class="o">=</span> aws_instance.web.public_ip
<span class="o">}</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Edita el atributo ami con el ID de AMI que se generó de la construcción de Packer.</p>
</div>
<div class="paragraph">
<p>Crea un nuevo archivo llamado <code>terraform.tfvars</code> y agrega la región donde se almacena la imagen como variable. Si personalizaste la región que te dio a Packer, debes cambiar esta región para que coincida, o Terraform no podrá acceder a la imagen.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash">region <span class="o">=</span> <span class="s2">"us-east-1"</span></code></pre>
</div>
</div>
<div class="paragraph">
<p>Guarda este archivo y luego inicializa y aplica la configuración de Terraform.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>terraform init <span class="o">&amp;&amp;</span> terraform apply</code></pre>
</div>
</div>
<div class="paragraph">
<p>Escriba sí cuando se  solicite crear la instancia. El resultado final es la dirección IP de la instancia.</p>
</div>
<div class="paragraph">
<p>La instancia ya contiene la llave SSH para realizar la conexión , porque terraform usó la AMI que se construyó previamente con Packer. El uso de una AMI construida con Packer hace que la implementación de instancias masivas sea más rápida y coherente que la configuración manual de las instancias.</p>
</div>
<div class="sect3">
<h4 id="_verificar_la_instancia">Verificar la instancia</h4>
<div class="paragraph">
<p>Conectate a la instancia a través de SSH con el atributo obteniendo la ip del atributo <code>aws_instance.web.public_ip</code></p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>ssh terraform@<span class="si">$(</span><span class="nb">echo</span> <span class="s2">"aws_instance.web.public_ip"</span> | terraform console<span class="si">)</span> <span class="nt">-i</span> ../tf-packer</code></pre>
</div>
</div>
<div class="paragraph">
<p>Ahora tienes acceso SSH a tus instancias de AWS sin crear una clave SSH en AWS. Esto es útil si tu organización mantiene pares de claves fuera de AWS.</p>
</div>
<div class="paragraph">
<p>Navega hasta el directorio de Go.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span><span class="nb">cd </span>go/src/github.com/hashicorp/learn-go-webapp-demo</code></pre>
</div>
</div>
<div class="paragraph">
<p>Inicie la aplicación web demo.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>go run webapp.go</code></pre>
</div>
</div>
<div class="paragraph">
<p>En el navegador web, navega hasta la dirección IP de la instancia y el puerto 8080 para ver la aplicación que implementaste.</p>
</div>
</div>
<div class="sect3">
<h4 id="_destruye_la_instancia">Destruye la instancia</h4>
<div class="paragraph">
<p>Evita cargos innecesarios en tu cuenta de AWS destruyendo su instancia en Terraform.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="rouge highlight"><code data-lang="bash"><span class="nv">$ </span>terraform destruir</code></pre>
</div>
</div>
<div class="paragraph">
<p>Escribe sí cuando se  solicite en la terminal la confirmación.</p>
</div>
<div class="paragraph">
<p>Esto no destruirá la imagen de Packer.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_creación_y_configuración_de_una_cuenta_de_amazon_web_services">Apéndice A: Creación y configuración de una cuenta de <em>Amazon Web Services</em></h2>
<div class="sectionbody">
<div class="paragraph">
<p>TODO</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_glosario">Glosario</h2>
<div class="sectionbody">
<div class="dlist glossary">
<dl>
<dt>AWS</dt>
<dd>
<p>Amazon Web Services</p>
</dd>
</dl>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bibliografía">Bibliografía</h2>
<div class="sectionbody">
<div class="ulist bibliography">
<ul class="bibliography">
<li>
<p><a id="intro_terraform"></a>[intro_terraform] HashiCorp. (2020). Introduction to Infrastructure as Code with Terraform. 2021, de Hashicorp Sitio web: <a href="https://learn.hashicorp.com/tutorials/terraform/infrastructure-as-code?in=terraform/aws-get-started" class="bare">https://learn.hashicorp.com/tutorials/terraform/infrastructure-as-code?in=terraform/aws-get-started</a></p>
</li>
<li>
<p><a id="intro_packer"></a>[intro_packer] HashiCorp. (2020). Provision Infrastructure with Packer. 2021, de Hashicorp Sitio web: <a href="https://learn.hashicorp.com/tutorials/terraform/packer" class="bare">https://learn.hashicorp.com/tutorials/terraform/packer</a></p>
</li>
</ul>
</div>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. Yet Another Markup Lenguage
</div>
<div class="footnote" id="_footnotedef_2">
<a href="#_footnoteref_2">2</a>. Continous Integration / Continous Delivery
</div>
<div class="footnote" id="_footnotedef_3">
<a href="#_footnoteref_3">3</a>. <a href="https://www.terraform.io/" class="bare">https://www.terraform.io/</a>
</div>
<div class="footnote" id="_footnotedef_4">
<a href="#_footnoteref_4">4</a>. <a href="https://www.terraform.io/intro/use-cases.html" class="bare">https://www.terraform.io/intro/use-cases.html</a>
</div>
<div class="footnote" id="_footnotedef_5">
<a href="#_footnoteref_5">5</a>. Este es el caso de uso específico que estaremos cubriendo en esta obra.
</div>
<div class="footnote" id="_footnotedef_6">
<a href="#_footnoteref_6">6</a>. <a href="https://www.terraform.io/downloads.html" class="bare">https://www.terraform.io/downloads.html</a>
</div>
<div class="footnote" id="_footnotedef_7">
<a href="#_footnoteref_7">7</a>. <a href="https://www.terraform.io/docs/providers/index.html" class="bare">https://www.terraform.io/docs/providers/index.html</a>
</div>
<div class="footnote" id="_footnotedef_8">
<a href="#_footnoteref_8">8</a>. <a href="https://www.packer.io/docs/builders" class="bare">https://www.packer.io/docs/builders</a>
</div>
<div class="footnote" id="_footnotedef_9">
<a href="#_footnoteref_9">9</a>. <a href="https://www.packer.io/docs/provisioners" class="bare">https://www.packer.io/docs/provisioners</a>
</div>
<div class="footnote" id="_footnotedef_10">
<a href="#_footnoteref_10">10</a>. <a href="https://www.packer.io/intro/use-cases" class="bare">https://www.packer.io/intro/use-cases</a>
</div>
<div class="footnote" id="_footnotedef_11">
<a href="#_footnoteref_11">11</a>. <a href="https://spinnaker.io/setup/bakery/#packer-templates" class="bare">https://spinnaker.io/setup/bakery/#packer-templates</a>
</div>
<div class="footnote" id="_footnotedef_12">
<a href="#_footnoteref_12">12</a>. <a href="https://www.packer.io/downloads" class="bare">https://www.packer.io/downloads</a>
</div>
</div>
<div id="footer">
<div id="footer-text">
Version 1.0<br>
Last updated 2021-02-08 11:32:54 -0600
</div>
</div>
</body>
</html>